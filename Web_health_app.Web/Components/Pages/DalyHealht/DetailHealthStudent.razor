@page "/dalyhealth/detailhealthstudent/{studentUserId}"
@using Microsoft.AspNetCore.Authorization
@using System.Globalization
@using Web_health_app.Web.ApiClients.Atlas
@using Web_health_app.ApiService.Entities.NonSQLTable
@using Web_health_app.Models.Models.NonSqlDTO
@using System.Text.Json
@using System.Text
@attribute [Authorize(Roles = "ACCESS.DetailHealthStudent")]

@using Web_health_app.Web.Components.Layout

@inject AtlasApiClient AtlasApi
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@layout EmptyLayout

<link href="/css/DalyHealth/detail-health-student.css" rel="stylesheet" />

<style>
    .status-icon.connected {
        color: #28a745;
    }
    
    .status-icon.disconnected {
        color: #dc3545;
    }
    
    .sync-status.success {
        color: #28a745;
    }
    
    .sync-status.warning {
        color: #ffc107;
    }
    
    .sync-details h6 {
        margin-bottom: 1rem;
        color: #495057;
        font-weight: 600;
    }
    
    .device-info {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    /* Health Statistics Styles */
    .stats-comparison-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-comparison-card {
        background: #fff;
        border: 1px solid #e3e6f0;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transition: all 0.3s;
    }

    .stat-comparison-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.25rem 2rem 0 rgba(58, 59, 69, 0.2);
    }

    .stat-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .stat-header i {
        font-size: 1.5rem;
        margin-right: 0.75rem;
        width: 2rem;
        text-align: center;
    }

    .stat-comparison-card.steps .stat-header i { color: #5e72e4; }
    .stat-comparison-card.heart-rate .stat-header i { color: #f5365c; }
    .stat-comparison-card.calories .stat-header i { color: #fb6340; }
    .stat-comparison-card.sleep .stat-header i { color: #11cdef; }

    .stat-header h5 {
        margin: 0;
        font-weight: 600;
        color: #5a5c69;
    }

    .stat-values {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .current-value, .average-value {
        text-align: center;
    }

    .current-value .label, .average-value .label {
        display: block;
        font-size: 0.875rem;
        color: #6e707e;
        margin-bottom: 0.25rem;
    }

    .current-value .value, .average-value .value {
        display: block;
        font-size: 1.5rem;
        font-weight: 700;
        color: #5a5c69;
    }

    .trend-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .trend-indicator i {
        font-size: 1.25rem;
        margin-bottom: 0.25rem;
    }

    .trend-indicator span {
        font-size: 0.875rem;
        font-weight: 600;
    }

    .progress-bar-comparison .progress-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .progress-bar-comparison .progress-item span {
        min-width: 80px;
        font-size: 0.875rem;
        color: #6e707e;
    }

    .progress-bar-comparison .progress {
        flex: 1;
        height: 0.5rem;
        margin-left: 1rem;
    }

    .heart-rate-ranges, .sleep-quality-comparison {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e3e6f0;
    }

    .range-item, .quality-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
        color: #6e707e;
    }

    .period-summary {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        border-left: 4px solid #5e72e4;
    }

    .period-summary h5 {
        color: #5a5c69;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem;
        background: white;
        border-radius: 0.375rem;
        border: 1px solid #e3e6f0;
    }

    .summary-item .label {
        color: #6e707e;
        font-weight: 500;
    }

    .summary-item .value {
        color: #5a5c69;
        font-weight: 600;
    }

    .daily-breakdown {
        background: #fff;
        border-radius: 0.5rem;
        padding: 1.5rem;
        border: 1px solid #e3e6f0;
    }

    .daily-breakdown h5 {
        color: #5a5c69;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .breakdown-table {
        overflow-x: auto;
    }

    .table-header, .table-row {
        display: grid;
        grid-template-columns: 80px 100px 100px 100px 80px 120px;
        gap: 1rem;
        padding: 0.75rem;
        align-items: center;
    }

    .table-header {
        background: #f8f9fa;
        border-radius: 0.375rem;
        font-weight: 600;
        color: #5a5c69;
        border-bottom: 2px solid #e3e6f0;
    }

    .table-row {
        border-bottom: 1px solid #e3e6f0;
        transition: background-color 0.2s;
    }

    .table-row:hover {
        background: #f8f9fa;
    }

    .table-row:last-child {
        border-bottom: none;
    }

    .table-row .date {
        font-weight: 600;
        color: #5a5c69;
    }

    .table-row .steps, .table-row .calories, .table-row .heart-rate, .table-row .sleep {
        font-weight: 500;
        color: #6e707e;
    }

    .table-row .status {
        display: flex;
        align-items: center;
        font-weight: 500;
    }

    .table-row .status i {
        margin-right: 0.5rem;
    }

    /* Media queries for responsive design */
    .media-responsive {
        /* Placeholder for responsive styles */
    }
</style>

<div class="detail-health-page">
    <!-- Page Header -->
    <div class="page-header">
        <div class="container-fluid">
            <div class="header-content">
                <div class="back-button">
                    <button class="btn btn-outline-secondary" @onclick="GoBack">
                        <i class="fas fa-arrow-left"></i>
                        Quay lại
                    </button>
                </div>
                <div class="header-info">
                    <div class="student-avatar-large">
                        <div class="avatar-fallback">
                            <i class="fas fa-user"></i>
                        </div>
                    </div>
                    @if (student != null)
                    {
                        <div class="student-details">
                            <h2>@student.FullName</h2>
                            <p class="student-info">@student.Department - @student.Role</p>
                            <div class="sync-info">
                                @{
                                    var deviceStatus = GetDeviceStatus();
                                }
                                @if (deviceStatus.IsOnline)
                                {
                                    <span class="sync-status">
                                        <i class="fas fa-check-circle text-success"></i>
                                        Đang hoạt động
                                    </span>
                                    <span class="last-sync">Cập nhật lần cuối: @deviceStatus.LastSync</span>
                                }
                                else if (deviceStatus.HasDevices)
                                {
                                    <span class="sync-status">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                        Offline
                                    </span>
                                    <span class="last-sync">Cập nhật lần cuối: @deviceStatus.LastSync</span>
                                }
                                else
                                {
                                    <span class="sync-status">
                                        <i class="fas fa-times-circle text-danger"></i>
                                        Chưa kết nối thiết bị
                                    </span>
                                    <span class="last-sync">Chưa có dữ liệu đồng bộ</span>
                                }
                            </div>
                        </div>
                    }
                    else if (isLoading)
                    {
                        <div class="student-details">
                            <h2>Đang tải...</h2>
                            <p class="student-info">Đang lấy thông tin học sinh</p>
                        </div>
                    }
                    else
                    {
                        <div class="student-details">
                            <h2>Không tìm thấy</h2>
                            <p class="student-info">Không tìm thấy thông tin học sinh</p>
                        </div>
                    }
                </div>
              
              
                
                <div class="header-actions">
                    <button class="btn btn-outline-primary" @onclick="RefreshData" disabled="@isLoading">
                        <i class="fas fa-sync-alt @(isLoading ? "fa-spin" : "")"></i>
                        @(isLoading ? "Đang tải..." : "Đồng bộ lại")
                    </button>
                    <button class="btn btn-outline-info btn-sm" @onclick:stopPropagation="true">
                        <i class="fas fa-comments"></i>
                        Ghi chú
                    </button>
                    <button class="btn btn-primary" disabled="@(student == null || isGeneratingReport)" @onclick="GenerateHealthReport">
                        @if (isGeneratingReport)
                        {
                            <i class="fas fa-spinner fa-spin"></i>
                            @("Đang tạo...")
                        }
                        else
                        {
                            <i class="fas fa-download"></i>
                            @("Xuất báo cáo")
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Message / Debug Info -->
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="container-fluid mt-3">
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                @errorMessage
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="container-fluid mt-3">
            <div class="alert alert-info" role="alert">
                <i class="fas fa-spinner fa-spin"></i>
                Đang tải dữ liệu...
            </div>
        </div>
    }

   

    <!-- Health Overview Cards -->
    @if (!isLoading && student != null)
    {
        <div class="container-fluid">
            <div class="overview-section">
                <div class="row g-4">
                    @{
                        var healthMetrics = GetHealthMetrics();
                    }

                    <div class="col-lg-3 col-md-6">
                        <div class="health-overview-card steps">
                            <div class="card-icon">
                                <i class="fas fa-walking"></i>
                            </div>
                            <div class="card-content">
                                @if (healthMetrics.Steps > 0)
                                {
                                    <h3>@healthMetrics.Steps.ToString("#,0")</h3>
                                    <p>Bước chân hôm nay</p>
                                    <div class="progress-container">
                                        @{
                                            var stepsGoal = 6000;
                                            var stepsProgress = stepsGoal > 0 ? Math.Min(100, (healthMetrics.Steps * 100) / stepsGoal) : 0;
                                        }
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: @(stepsProgress)%"></div>
                                        </div>
                                        <small>Mục tiêu: @stepsGoal.ToString("#,0") bước</small>
                                    </div>
                                }
                                else
                                {
                                    <h3>--</h3>
                                    <p>Chưa có dữ liệu bước chân</p>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 0%"></div>
                                        </div>
                                        <small>Mục tiêu: 6,000 bước</small>
                                    </div>
                                }
                            </div>
                            <div class="trend-indicator @(GetStepsStatus(healthMetrics.Steps))">
                                <i class="fas fa-@(healthMetrics.Steps > 0 ? "walking" : "times")"></i>
                                @GetStepsStatusText(healthMetrics.Steps)
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="health-overview-card calories">
                            <div class="card-icon">
                                <i class="fas fa-fire"></i>
                            </div>
                            <div class="card-content">
                                @if (healthMetrics.Calories > 0)
                                {
                                    <h3>@healthMetrics.Calories.ToString("#,0")</h3>
                                    <p>Calories đã đốt</p>
                                    <div class="progress-container">
                                        @{
                                            var caloriesGoal = 2400;
                                            var caloriesProgress = caloriesGoal > 0 ? Math.Min(100, (healthMetrics.Calories * 100) / caloriesGoal) : 0;
                                        }
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: @(caloriesProgress)%"></div>
                                        </div>
                                        <small>Mục tiêu: @caloriesGoal.ToString("#,0") calories</small>
                                    </div>
                                }
                                else
                                {
                                    <h3>--</h3>
                                    <p>Chưa có dữ liệu calories</p>
                                    <div class="progress-container">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: 0%"></div>
                                        </div>
                                        <small>Mục tiêu: 2,400 calories</small>
                                    </div>
                                }
                            </div>
                            <div class="trend-indicator @(GetCaloriesStatus(healthMetrics.Calories))">
                                <i class="fas fa-@(healthMetrics.Calories > 0 ? "fire" : "times")"></i>
                                @GetCaloriesStatusText(healthMetrics.Calories)
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="health-overview-card heart-rate">
                            <div class="card-icon">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="card-content">
                                @if (healthMetrics.HeartRate > 0)
                                {
                                    <h3>@healthMetrics.HeartRate.ToString("F0") BPM</h3>
                                    <p>Nhịp tim trung bình</p>
                                    <div class="heart-rate-zones">
                                        <div class="zone-item">
                                            <span class="zone-label">Nghỉ ngơi:</span>
                                            <span class="zone-value">60-100 BPM</span>
                                        </div>
                                        <div class="zone-item">
                                            <span class="zone-label">Tập luyện:</span>
                                            <span class="zone-value">120-140 BPM</span>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <h3>-- BPM</h3>
                                    <p>Chưa có dữ liệu nhịp tim</p>
                                    <div class="heart-rate-zones">
                                        <div class="zone-item">
                                            <span class="zone-label">Nghỉ ngơi:</span>
                                            <span class="zone-value">60-100 BPM</span>
                                        </div>
                                        <div class="zone-item">
                                            <span class="zone-label">Tập luyện:</span>
                                            <span class="zone-value">120-140 BPM</span>
                                        </div>
                                    </div>
                                }
                            </div>
                            <div class="trend-indicator @(GetHeartRateStatus(healthMetrics.HeartRate))">
                                <i class="fas fa-@(healthMetrics.HeartRate > 0 ? "heartbeat" : "times")"></i>
                                @GetHeartRateStatusText(healthMetrics.HeartRate)
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="health-overview-card sleep">
                            <div class="card-icon">
                                <i class="fas fa-bed"></i>
                            </div>
                            <div class="card-content">
                                @if (healthMetrics.Sleep > 0)
                                {
                                    var hours = (int)healthMetrics.Sleep;
                                    var minutes = (int)((healthMetrics.Sleep - hours) * 60);
                                    <h3>@(hours)h @(minutes)m</h3>
                                    <p>Giấc ngủ đêm qua</p>
                                    <div class="sleep-quality">
                                        <div class="quality-score @(GetSleepStatus(healthMetrics.Sleep))">
                                            <span class="score">@(GetSleepQualityScore(healthMetrics.Sleep))%</span>
                                            <span class="label">@GetSleepStatusText(healthMetrics.Sleep)</span>
                                        </div>
                                        <div class="sleep-stages">
                                            <small>Tổng thời gian: @(hours)h @(minutes)m</small>
                                            <small>Chất lượng: @GetSleepQuality(healthMetrics.Sleep)</small>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <h3>-- h --m</h3>
                                    <p>Chưa có dữ liệu giấc ngủ</p>
                                    <div class="sleep-quality">
                                        <div class="quality-score no-data">
                                            <span class="score">--%</span>
                                            <span class="label">Chưa có dữ liệu</span>
                                        </div>
                                        <div class="sleep-stages">
                                            <small>Mục tiêu: 7-9 giờ</small>
                                        </div>
                                    </div>
                                }
                            </div>
                            <div class="trend-indicator @(GetSleepStatus(healthMetrics.Sleep))">
                                <i class="fas fa-@(healthMetrics.Sleep > 0 ? "moon" : "times")"></i>
                                @GetSleepStatusText(healthMetrics.Sleep)
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Charts Section -->
            <div class="charts-section">
                <div class="row g-4">
                    <!-- Health Statistics Overview -->
                    <div class="col-12">
                        <div class="chart-card">
                            <div class="chart-header">
                                <h4>
                                    <i class="fas fa-chart-bar"></i>
                                    Thống kê chỉ số sức khỏe
                                </h4>
                                <div class="chart-controls">
                                    <button class="btn btn-sm btn-outline-secondary @(selectedPeriod == "today" ? "active" : "")" 
                                            @onclick="@(() => ChangePeriod("today"))">Hôm nay</button>
                                    <button class="btn btn-sm btn-outline-secondary @(selectedPeriod == "week" ? "active" : "")" 
                                            @onclick="@(() => ChangePeriod("week"))">7 ngày</button>
                                    <button class="btn btn-sm btn-outline-secondary @(selectedPeriod == "2weeks" ? "active" : "")" 
                                            @onclick="@(() => ChangePeriod("2weeks"))">2 tuần</button>
                                    <button class="btn btn-sm btn-outline-secondary @(selectedPeriod == "month" ? "active" : "")" 
                                            @onclick="@(() => ChangePeriod("month"))">30 ngày</button>
                                </div>
                            </div>
                            <div class="chart-content">
                                @{
                                    var periodStats = GetHealthStatsByPeriod(selectedPeriod);
                                }
                                
                                <!-- Current vs Average Comparison -->
                                <div class="stats-comparison-grid">
                                    <!-- Steps Comparison -->
                                    <div class="stat-comparison-card steps">
                                        <div class="stat-header">
                                            <i class="fas fa-walking"></i>
                                            <h5>Bước chân</h5>
                                        </div>
                                        <div class="stat-values">
                                            <div class="current-value">
                                                <span class="label">Hiện tại</span>
                                                <span class="value">@(periodStats.CurrentSteps > 0 ? periodStats.CurrentSteps.ToString("#,0") : "--")</span>
                                            </div>
                                            <div class="average-value">
                                                <span class="label">Trung bình @GetPeriodLabel(selectedPeriod)</span>
                                                <span class="value">@(periodStats.AvgSteps > 0 ? periodStats.AvgSteps.ToString("#,0") : "--")</span>
                                            </div>
                                            <div class="trend-indicator">
                                                @if (periodStats.CurrentSteps > 0 && periodStats.AvgSteps > 0)
                                                {
                                                    var stepsTrend = periodStats.CurrentSteps - periodStats.AvgSteps;
                                                    <i class="fas fa-@(stepsTrend > 0 ? "arrow-up text-success" : stepsTrend < 0 ? "arrow-down text-danger" : "minus text-muted")"></i>
                                                    <span class="@(stepsTrend > 0 ? "text-success" : stepsTrend < 0 ? "text-danger" : "text-muted")">
                                                        @(stepsTrend != 0 ? Math.Abs(stepsTrend).ToString("#,0") : "Không đổi")
                                                    </span>
                                                }
                                                else
                                                {
                                                    <i class="fas fa-times text-muted"></i>
                                                    <span class="text-muted">Chưa có dữ liệu</span>
                                                }
                                            </div>
                                        </div>
                                        <div class="progress-bar-comparison">
                                            <div class="progress-item">
                                                <span>Hiện tại</span>
                                                <div class="progress">
                                                    <div class="progress-bar bg-primary" style="width: @(periodStats.CurrentSteps > 0 ? Math.Min(100, (periodStats.CurrentSteps * 100.0 / 10000)) : 0)%"></div>
                                                </div>
                                            </div>
                                            <div class="progress-item">
                                                <span>Trung bình</span>
                                                <div class="progress">
                                                    <div class="progress-bar bg-secondary" style="width: @(periodStats.AvgSteps > 0 ? Math.Min(100, (periodStats.AvgSteps * 100.0 / 10000)) : 0)%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Heart Rate Comparison -->
                                    <div class="stat-comparison-card heart-rate">
                                        <div class="stat-header">
                                            <i class="fas fa-heart"></i>
                                            <h5>Nhịp tim (BPM)</h5>
                                        </div>
                                        <div class="stat-values">
                                            <div class="current-value">
                                                <span class="label">Hiện tại</span>
                                                <span class="value">@periodStats.CurrentHeartRate.ToString("F0")</span>
                                            </div>
                                            <div class="average-value">
                                                <span class="label">Trung bình @GetPeriodLabel(selectedPeriod)</span>
                                                <span class="value">@periodStats.AvgHeartRate.ToString("F0")</span>
                                            </div>
                                            <div class="trend-indicator">
                                                @{
                                                    var hrTrend = periodStats.CurrentHeartRate - periodStats.AvgHeartRate;
                                                }
                                                <i class="fas fa-@(hrTrend > 0 ? "arrow-up text-warning" : hrTrend < 0 ? "arrow-down text-success" : "minus text-muted")"></i>
                                                <span class="@(hrTrend > 0 ? "text-warning" : hrTrend < 0 ? "text-success" : "text-muted")">
                                                    @(hrTrend != 0 ? Math.Abs(hrTrend).ToString("F0") : "Không đổi")
                                                </span>
                                            </div>
                                        </div>
                                        <div class="heart-rate-ranges">
                                            <div class="range-item">
                                                <span>Min: @periodStats.MinHeartRate.ToString("F0") BPM</span>
                                                <span>Max: @periodStats.MaxHeartRate.ToString("F0") BPM</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Calories Comparison -->
                                    <div class="stat-comparison-card calories">
                                        <div class="stat-header">
                                            <i class="fas fa-fire"></i>
                                            <h5>Calories</h5>
                                        </div>
                                        <div class="stat-values">
                                            <div class="current-value">
                                                <span class="label">Hiện tại</span>
                                                <span class="value">@periodStats.CurrentCalories.ToString("#,0")</span>
                                            </div>
                                            <div class="average-value">
                                                <span class="label">Trung bình @GetPeriodLabel(selectedPeriod)</span>
                                                <span class="value">@periodStats.AvgCalories.ToString("#,0")</span>
                                            </div>
                                            <div class="trend-indicator">
                                                @{
                                                    var caloriesTrend = periodStats.CurrentCalories - periodStats.AvgCalories;
                                                }
                                                <i class="fas fa-@(caloriesTrend > 0 ? "arrow-up text-success" : caloriesTrend < 0 ? "arrow-down text-danger" : "minus text-muted")"></i>
                                                <span class="@(caloriesTrend > 0 ? "text-success" : caloriesTrend < 0 ? "text-danger" : "text-muted")">
                                                    @(caloriesTrend != 0 ? Math.Abs(caloriesTrend).ToString("#,0") : "Không đổi")
                                                </span>
                                            </div>
                                        </div>
                                        <div class="progress-bar-comparison">
                                            <div class="progress-item">
                                                <span>Hiện tại</span>
                                                <div class="progress">
                                                    <div class="progress-bar bg-warning" style="width: @Math.Min(100, (periodStats.CurrentCalories * 100.0 / 2400))%"></div>
                                                </div>
                                            </div>
                                            <div class="progress-item">
                                                <span>Trung bình</span>
                                                <div class="progress">
                                                    <div class="progress-bar bg-secondary" style="width: @Math.Min(100, (periodStats.AvgCalories * 100.0 / 2400))%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sleep Comparison -->
                                    <div class="stat-comparison-card sleep">
                                        <div class="stat-header">
                                            <i class="fas fa-bed"></i>
                                            <h5>Giấc ngủ (giờ)</h5>
                                        </div>
                                        <div class="stat-values">
                                            <div class="current-value">
                                                <span class="label">Hiện tại</span>
                                                <span class="value">@periodStats.CurrentSleep.ToString("F1")h</span>
                                            </div>
                                            <div class="average-value">
                                                <span class="label">Trung bình @GetPeriodLabel(selectedPeriod)</span>
                                                <span class="value">@periodStats.AvgSleep.ToString("F1")h</span>
                                            </div>
                                            <div class="trend-indicator">
                                                @{
                                                    var sleepTrend = periodStats.CurrentSleep - periodStats.AvgSleep;
                                                }
                                                <i class="fas fa-@(sleepTrend > 0 ? "arrow-up text-success" : sleepTrend < 0 ? "arrow-down text-warning" : "minus text-muted")"></i>
                                                <span class="@(sleepTrend > 0 ? "text-success" : sleepTrend < 0 ? "text-warning" : "text-muted")">
                                                    @(sleepTrend != 0 ? Math.Abs(sleepTrend).ToString("F1") + "h" : "Không đổi")
                                                </span>
                                            </div>
                                        </div>
                                        <div class="sleep-quality-comparison">
                                            <div class="quality-item">
                                                <span>Chất lượng: @GetSleepQuality(periodStats.CurrentSleep)</span>
                                                <span>Điểm: @GetSleepQualityScore(periodStats.CurrentSleep)/100</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Period Summary -->
                                <div class="period-summary mt-4">
                                    <h5><i class="fas fa-chart-line"></i> Tóm tắt @GetPeriodLabel(selectedPeriod)</h5>
                                    <div class="summary-grid">
                                        <div class="summary-item">
                                            <span class="label">Tổng số ngày có dữ liệu:</span>
                                            <span class="value">@periodStats.DaysWithData/@GetPeriodDays(selectedPeriod) ngày</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="label">Ngày hoàn thành mục tiêu bước chân:</span>
                                            <span class="value">@periodStats.DaysWithStepsGoal/@periodStats.DaysWithData ngày</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="label">Tổng bước chân:</span>
                                            <span class="value">@periodStats.TotalSteps.ToString("#,0") bước</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="label">Tổng calories đốt cháy:</span>
                                            <span class="value">@periodStats.TotalCalories.ToString("#,0") cal</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="label">Thời gian ngủ trung bình:</span>
                                            <span class="value">@periodStats.AvgSleep.ToString("F1") giờ/đêm</span>
                                        </div>
                                        <div class="summary-item">
                                            <span class="label">Nhịp tim nghỉ ngơi trung bình:</span>
                                            <span class="value">@periodStats.AvgRestingHeartRate.ToString("F0") BPM</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Daily Breakdown (for weekly/monthly view) -->
                                @if (selectedPeriod != "today")
                                {
                                    <div class="daily-breakdown mt-4">
                                        <h5><i class="fas fa-calendar-alt"></i> Phân tích theo ngày</h5>
                                        <div class="breakdown-table">
                                            <div class="table-header">
                                                <span>Ngày</span>
                                                <span>Bước chân</span>
                                                <span>Calories</span>
                                                <span>Nhịp tim TB</span>
                                                <span>Giờ ngủ</span>
                                                <span>Trạng thái</span>
                                            </div>
                                            @{
                                                var validDays = GetDailyBreakdown(selectedPeriod).Where(d => d.HasValidData()).ToList();
                                            }
                                            @if (validDays.Any())
                                            {
                                                @foreach (var day in validDays)
                                                {
                                                    <div class="table-row">
                                                        <span class="date">@day.Date.ToString("dd/MM")</span>
                                                        <span class="steps">@(day.Steps > 0 ? day.Steps.ToString("#,0") : "--")</span>
                                                        <span class="calories">@(day.Calories > 0 ? day.Calories.ToString("#,0") : "--")</span>
                                                        <span class="heart-rate">@(day.HeartRate > 0 ? day.HeartRate.ToString("F0") : "--")</span>
                                                        <span class="sleep">@(day.Sleep > 0 ? day.Sleep.ToString("F1") + "h" : "--")</span>
                                                        <span class="status">
                                                            <i class="fas fa-circle @(day.IsGoodDay ? "text-success" : "text-warning")"></i>
                                                            @(day.IsGoodDay ? "Tốt" : "Cần cải thiện")
                                                        </span>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <div class="table-row">
                                                    <span colspan="6" class="text-center text-muted">Không có dữ liệu hợp lệ trong khoảng thời gian này</span>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Insights Section -->
            <div class="insights-section">
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="insights-card">
                            <div class="card-header">
                                <h4>
                                    <i class="fas fa-chart-line"></i>
                                    Thống kê tuần qua
                                </h4>
                            </div>
                            <div class="chart-content">
                                <div class="weekly-stats">
                                    @{
                                        var weeklyStats = GetWeeklyStatistics();
                                    }
                                    
                                    <div class="stat-item">
                                        <div class="stat-icon steps">
                                            <i class="fas fa-walking"></i>
                                        </div>
                                        <div class="stat-data">
                                            <h5>@(weeklyStats.TotalSteps.ToString("N0"))</h5>
                                            <p>Tổng bước chân</p>
                                            <div class="stat-change @GetChangeClass(weeklyStats.StepsChange)">
                                                <i class="fas fa-@GetChangeIcon(weeklyStats.StepsChange)"></i>
                                                @GetChangeText(weeklyStats.StepsChange, "bước") so với tuần trước
                                            </div>
                                        </div>
                                    </div>

                                    <div class="stat-item">
                                        <div class="stat-icon calories">
                                            <i class="fas fa-fire"></i>
                                        </div>
                                        <div class="stat-data">
                                            <h5>@(weeklyStats.TotalCalories.ToString("N0"))</h5>
                                            <p>Tổng calories</p>
                                            <div class="stat-change @GetChangeClass(weeklyStats.CaloriesChange)">
                                                <i class="fas fa-@GetChangeIcon(weeklyStats.CaloriesChange)"></i>
                                                @GetChangeText(weeklyStats.CaloriesChange, "cal") so với tuần trước
                                            </div>
                                        </div>
                                    </div>

                                    <div class="stat-item">
                                        <div class="stat-icon heart-rate">
                                            <i class="fas fa-heart"></i>
                                        </div>
                                        <div class="stat-data">
                                            <h5>@(weeklyStats.AvgHeartRate > 0 ? weeklyStats.AvgHeartRate.ToString("0") + " BPM" : "--")</h5>
                                            <p>Nhịp tim TB</p>
                                            <div class="stat-change @GetChangeClass(weeklyStats.HeartRateChange)">
                                                <i class="fas fa-@GetChangeIcon(weeklyStats.HeartRateChange)"></i>
                                                @GetChangeText(weeklyStats.HeartRateChange, "BPM", isHeartRate: true)
                                            </div>
                                        </div>
                                    </div>

                                    <div class="stat-item">
                                        <div class="stat-icon sleep">
                                            <i class="fas fa-bed"></i>
                                        </div>
                                        <div class="stat-data">
                                            <h5>@(weeklyStats.AvgSleep > 0 ? FormatSleepTime(weeklyStats.AvgSleep) : "--")</h5>
                                            <p>Giấc ngủ TB</p>
                                            <div class="stat-change @GetChangeClass(weeklyStats.SleepChange)">
                                                <i class="fas fa-@GetChangeIcon(weeklyStats.SleepChange)"></i>
                                                @GetSleepChangeText(weeklyStats.SleepChange)
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Health Insights Section -->
            <div class="insights-section">
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="insights-card">
                            <div class="card-header">
                                <h4>
                                    <i class="fas fa-lightbulb"></i>
                                    Nhận xét sức khỏe
                                </h4>
                            </div>
                            <div class="card-body">
                                @{
                                    var healthInsights = GetHealthInsights();
                                }
                                
                                @foreach (var insight in healthInsights)
                                {
                                    <div class="insight-item @insight.Type">
                                        <div class="insight-icon">
                                            <i class="fas fa-@insight.Icon"></i>
                                        </div>
                                        <div class="insight-content">
                                            <h5>@insight.Title</h5>
                                            <p>@insight.Message</p>
                                        </div>
                                    </div>
                                }
                                
                                @if (!healthInsights.Any())
                                {
                                    <div class="insight-item info">
                                        <div class="insight-icon">
                                            <i class="fas fa-info-circle"></i>
                                        </div>
                                        <div class="insight-content">
                                            <h5>Chưa có đủ dữ liệu</h5>
                                            <p>Cần thêm dữ liệu sức khỏe để đưa ra nhận xét chi tiết.</p>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="goals-card">
                            <div class="card-header">
                                <h4>
                                    <i class="fas fa-bullseye"></i>
                                    Mục tiêu sức khỏe
                                </h4>
                            </div>
                            <div class="card-body">
                                @{
                                    var healthGoals = GetHealthGoals();
                                }
                                
                                <div class="goal-item">
                                    <div class="goal-header">
                                        <span class="goal-title">Bước chân hàng ngày</span>
                                        <span class="goal-progress">@(healthGoals.StepsProgress)%</span>
                                    </div>
                                    <div class="goal-bar">
                                        <div class="goal-fill" style="width: @(healthGoals.StepsProgress)%"></div>
                                    </div>
                                    <div class="goal-details">
                                        <span>@(healthGoals.CurrentSteps.ToString("N0")) / @(healthGoals.StepsGoal.ToString("N0")) bước</span>
                                        <span class="goal-status @GetGoalStatusClass(healthGoals.StepsAchievedDays, 5)">@GetStepsGoalStatus(healthGoals.StepsAchievedDays)</span>
                                    </div>
                                </div>

                                <div class="goal-item">
                                    <div class="goal-header">
                                        <span class="goal-title">Calories đốt cháy</span>
                                        <span class="goal-progress">@(healthGoals.CaloriesProgress)%</span>
                                    </div>
                                    <div class="goal-bar">
                                        <div class="goal-fill calories" style="width: @(healthGoals.CaloriesProgress)%"></div>
                                    </div>
                                    <div class="goal-details">
                                        <span>@(healthGoals.CurrentCalories.ToString("N0")) / @(healthGoals.CaloriesGoal.ToString("N0")) calories</span>
                                        <span class="goal-status @GetGoalStatusClass(healthGoals.CaloriesProgress, 70)">@GetCaloriesGoalStatus(healthGoals.CaloriesProgress)</span>
                                    </div>
                                </div>

                                <div class="goal-item">
                                    <div class="goal-header">
                                        <span class="goal-title">Thời gian ngủ</span>
                                        <span class="goal-progress">@(healthGoals.SleepProgress)%</span>
                                    </div>
                                    <div class="goal-bar">
                                        <div class="goal-fill sleep" style="width: @(healthGoals.SleepProgress)%"></div>
                                    </div>
                                    <div class="goal-details">
                                        <span>@(healthGoals.CurrentSleep > 0 ? FormatSleepTime(healthGoals.CurrentSleep) : "--") / @(FormatSleepTime(healthGoals.SleepGoal))</span>
                                        <span class="goal-status @GetGoalStatusClass(healthGoals.SleepProgress, 85)">@GetSleepGoalStatus(healthGoals.SleepProgress)</span>
                                    </div>
                                </div>

                                <div class="goal-item">
                                    <div class="goal-header">
                                        <span class="goal-title">Hoạt động tuần</span>
                                        <span class="goal-progress">@(healthGoals.WeeklyActivityProgress)%</span>
                                    </div>
                                    <div class="goal-bar">
                                        <div class="goal-fill activity" style="width: @(healthGoals.WeeklyActivityProgress)%"></div>
                                    </div>
                                    <div class="goal-details">
                                        <span>@(healthGoals.ActiveDays) / 7 ngày hoạt động</span>
                                        <span class="goal-status @GetGoalStatusClass(healthGoals.ActiveDays, 5)">@GetActivityGoalStatus(healthGoals.ActiveDays)</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Device & Samsung Health Integration Status -->
            <div class="integration-section">
                <div class="integration-card">
                    <div class="card-header">
                        <h4>
                            <i class="fab fa-android"></i>
                            Trạng thái thiết bị & đồng bộ dữ liệu
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="integration-status">
                            @if (deviceStatus != null && deviceStatus.TotalDevices > 0 && deviceStatus.Devices != null)
                            {
                                @foreach (var device in deviceStatus.Devices)
                                {
                                    <div class="status-item">
                                        <div class="status-icon @(device.IsOnline ? "connected" : "disconnected")">
                                            <i class="fas fa-@(device.IsOnline ? "check-circle" : "times-circle")"></i>
                                        </div>
                                        <div class="status-info">
                                            <h5>
                                                @GetDeviceDisplayName(device.Model)
                                                @if (device.IsOnline)
                                                {
                                                    <span class="badge bg-success ms-2">Online</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger ms-2">Offline</span>
                                                }
                                            </h5>
                                            <p><strong>Device ID:</strong> @device.DeviceId</p>
                                            @if (!string.IsNullOrEmpty(device.OsVersion))
                                            {
                                                <p><strong>Android Version:</strong> @device.OsVersion</p>
                                            }
                                            @if (!string.IsNullOrEmpty(device.SdkVersion))
                                            {
                                                <p><strong>API Level:</strong> @device.SdkVersion</p>
                                            }
                                        </div>
                                        <div class="status-time">
                                            @if (!string.IsNullOrEmpty(device.LastSyncAt))
                                            {
                                                @if (DateTime.TryParse(device.LastSyncAt, null, DateTimeStyles.RoundtripKind, out DateTime lastSync))
                                                {
                                                    // Convert UTC to Vietnam timezone
                                                    var timeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
                                                    var localTime = TimeZoneInfo.ConvertTime(lastSync, timeZone);
                                                    var timeAgo = DateTime.Now - localTime;
                                                    
                                                    <span><strong>Đồng bộ lần cuối:</strong></span><br />
                                                    <span>@localTime.ToString("HH:mm dd/MM/yyyy")</span><br />
                                                    <small class="text-muted">
                                                        @if (timeAgo.TotalMinutes < 1)
                                                        {
                                                            <span>Vừa xong</span>
                                                        }
                                                        else if (timeAgo.TotalHours < 1)
                                                        {
                                                            <span>@((int)timeAgo.TotalMinutes) phút trước</span>
                                                        }
                                                        else if (timeAgo.TotalDays < 1)
                                                        {
                                                            <span>@((int)timeAgo.TotalHours) giờ trước</span>
                                                        }
                                                        else
                                                        {
                                                            <span>@((int)timeAgo.TotalDays) ngày trước</span>
                                                        }
                                                    </small>
                                                }
                                                else
                                                {
                                                    <span><strong>Đồng bộ lần cuối:</strong> @device.LastSyncAt</span>
                                                }
                                            }
                                            else
                                            {
                                                <span>Chưa có thông tin đồng bộ</span>
                                            }
                                            
                                            @if (!string.IsNullOrEmpty(device.RegisteredAt))
                                            {
                                                <br />
                                                @if (DateTime.TryParse(device.RegisteredAt, null, DateTimeStyles.RoundtripKind, out DateTime registered))
                                                {
                                                    var timeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
                                                    var localTime = TimeZoneInfo.ConvertTime(registered, timeZone);
                                                    <small class="text-muted"><strong>Đăng ký:</strong> @localTime.ToString("dd/MM/yyyy")</small>
                                                }
                                                else
                                                {
                                                    <small class="text-muted"><strong>Đăng ký:</strong> @device.RegisteredAt</small>
                                                }
                                            }
                                        </div>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="status-item">
                                    <div class="status-icon disconnected">
                                        <i class="fas fa-times-circle"></i>
                                    </div>
                                    <div class="status-info">
                                        <h5>Chưa có thiết bị kết nối</h5>
                                        <p>Học sinh chưa đăng ký thiết bị nào hoặc chưa cài đặt ứng dụng</p>
                                    </div>
                                    <div class="status-time">
                                        <span>Chưa có dữ liệu</span>
                                    </div>
                                </div>
                            }

                            <!-- Sensor Data Sync Status -->
                            @if (sensorReadings.Any())
                            {
                                <div class="sync-details">
                                    <h6>Trạng thái đồng bộ dữ liệu:</h6>
                                    @{
                                        var syncHealthMetrics = GetHealthMetrics();
                                        var sensorTypes = sensorReadings.Select(r => r.Metadata.SensorType).Where(s =>
                                        !string.IsNullOrEmpty(s)).Distinct().ToList();
                                    }
                                    
                                    <div class="sync-item">
                                        <i class="fas fa-walking"></i>
                                        <span>Bước chân</span>
                                        <div class="sync-status @(syncHealthMetrics.Steps > 0 ? "success" : "warning")">
                                            <i class="fas fa-@(syncHealthMetrics.Steps > 0 ? "check" : "exclamation-triangle")"></i>
                                            @(syncHealthMetrics.Steps > 0 ? "Đã đồng bộ" : "Chưa có dữ liệu")
                                        </div>
                                    </div>
                                    <div class="sync-item">
                                        <i class="fas fa-fire"></i>
                                        <span>Calories</span>
                                        <div class="sync-status @(syncHealthMetrics.Calories > 0 ? "success" : "warning")">
                                            <i class="fas fa-@(syncHealthMetrics.Calories > 0 ? "check" : "exclamation-triangle")"></i>
                                            @(syncHealthMetrics.Calories > 0 ? "Đã đồng bộ" : "Chưa có dữ liệu")
                                        </div>
                                    </div>
                                    <div class="sync-item">
                                        <i class="fas fa-heart"></i>
                                        <span>Nhịp tim</span>
                                        <div class="sync-status @(syncHealthMetrics.HeartRate > 0 ? "success" : "warning")">
                                            <i class="fas fa-@(syncHealthMetrics.HeartRate > 0 ? "check" : "exclamation-triangle")"></i>
                                            @(syncHealthMetrics.HeartRate > 0 ? "Đã đồng bộ" : "Chưa có dữ liệu")
                                        </div>
                                    </div>
                                    <div class="sync-item">
                                        <i class="fas fa-bed"></i>
                                        <span>Giấc ngủ</span>
                                        <div class="sync-status @(syncHealthMetrics.Sleep > 0 ? "success" : "warning")">
                                            <i class="fas fa-@(syncHealthMetrics.Sleep > 0 ? "check" : "exclamation-triangle")"></i>
                                            @(syncHealthMetrics.Sleep > 0 ? "Đã đồng bộ" : "Chưa có dữ liệu")
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            Sensor types có sẵn: @string.Join(", ", sensorTypes)
                                        </small>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="sync-details">
                                    <div class="sync-item">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>Không có dữ liệu sensor</span>
                                        <div class="sync-status warning">
                                            <i class="fas fa-times"></i>
                                            Chưa đồng bộ
                                        </div>
                                    </div>
                                </div>
                            }

                            <div class="last-sync-info">
                                <div class="sync-summary">
                                    @{
                                        var deviceSyncStatus = GetDeviceStatus();
                                    }
                                    <span class="sync-time">Lần đồng bộ cuối: @deviceSyncStatus.LastSync</span>
                                    <span class="sync-frequency">
                                        @if (deviceSyncStatus.IsOnline)
                                        {
                                            <span class="text-success">Tự động đồng bộ đang hoạt động</span>
                                        }
                                        else if (deviceSyncStatus.HasDevices)
                                        {
                                            <span class="text-warning">Thiết bị offline - cần kết nối lại</span>
                                        }
                                        else
                                        {
                                            <span class="text-danger">Chưa có thiết bị đăng ký</span>
                                        }
                                    </span>
                                </div>
                                <button class="btn btn-outline-primary btn-sm" @onclick="RefreshData" disabled="@isLoading">
                                    <i class="fas fa-@(isLoading ? "spinner fa-spin" : "sync-alt")"></i>
                                    @(isLoading ? "Đang đồng bộ..." : "Làm mới dữ liệu")
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (isLoading)
    {
        <div class="container-fluid">
            <div class="d-flex justify-content-center align-items-center" style="height: 400px;">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5>Đang tải dữ liệu sức khỏe...</h5>
                    <p class="text-muted">Vui lòng đợi trong giây lát</p>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="container-fluid">
            <div class="alert alert-warning text-center" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                <h5>Không có dữ liệu</h5>
                <p>Không tìm thấy thông tin sức khỏe cho học sinh này.</p>
                <button class="btn btn-primary" @onclick="RefreshData">
                    <i class="fas fa-refresh"></i>
                    Thử lại
                </button>
            </div>
        </div>
    }

    <!-- Debug Info (only show when there's data) -->
    @if (!isLoading && student != null)
    {
        <div class="container-fluid mt-3">
            <div class="alert alert-info" role="alert">
                <strong>Debug Info:</strong><br />
                - Student: @student.FullName (@student.Id)<br />
                - Sensor Readings: @sensorReadings.Count records<br />
                - Device Status: @(deviceStatus != null ? $"{deviceStatus.TotalDevices} devices" : "No device data")<br />
                @{
                    var debugHealthMetrics = GetHealthMetrics();
                    var sensorTypes = sensorReadings.Select(r => r.Metadata.SensorType).Where(s =>
                    !string.IsNullOrEmpty(s)).Distinct().ToList();
                }
                - Health Data: HR=@debugHealthMetrics.HeartRate, Steps=@debugHealthMetrics.Steps,
                Sleep=@debugHealthMetrics.Sleep, Calories=@debugHealthMetrics.Calories<br />
                - Sensor Types Available: @string.Join(", ", sensorTypes)<br />
                - Data Readings Count: HR=@debugHealthMetrics.HeartRateReadings.Count,
                Steps=@debugHealthMetrics.StepsReadings.Count, Sleep=@debugHealthMetrics.SleepReadings.Count,
                Calories=@debugHealthMetrics.CalorieReadings.Count<br />
                @if (deviceStatus != null)
                {
                    <text><strong>Device Details:</strong><br /></text>
                    <text>- Total Devices: @deviceStatus.TotalDevices<br /></text>
                    <text>- Online Devices: @deviceStatus.OnlineDevices<br /></text>
                    <text>- Offline Devices: @deviceStatus.OfflineDevices<br /></text>
                    @if (deviceStatus.Devices != null && deviceStatus.Devices.Any())
                    {
                        @foreach (var device in deviceStatus.Devices)
                        {
                            <span>- Device: @device.Model (@device.DeviceId)</span>
            
                            <br />
                            <span>&nbsp;&nbsp;Status: @device.Status | IsOnline: @device.IsOnline</span>

                            <br />
                            <span>&nbsp;&nbsp;OS: @device.OsVersion | SDK: @device.SdkVersion</span>

                            <br />
                            <span>&nbsp;&nbsp;LastSync: @device.LastSyncAt</span>

                            <br />
                            <span>&nbsp;&nbsp;Registered: @device.RegisteredAt</span>

                            <br />
                        }
                    }
                    else
                    {
                        <span>- No devices found in collection</span>
            
                        <br />
                    }
                }
                else
                {
                    <span>- Device Status is null</span>
            
                    <br />
                }
                <br />
                <button class="btn btn-sm btn-outline-primary mt-2" @onclick="RefreshData">
                    <i class="fas fa-refresh"></i>
                    Debug Refresh
                </button>
            </div>
        </div>
    }

</div>

@code {
    [Parameter] public string StudentUserId { get; set; } = string.Empty;
    [Inject] private AtlasApiClient _atlasApiClient { get; set; } = default!;
    [Inject] private NavigationManager _navigationManager { get; set; } = default!;

    private User? student;
    private DeviceStatusSummary? deviceStatus;
    private List<SensorReadingInfoDto> sensorReadings = new();
    private bool isLoading = true;
    private bool isGeneratingReport = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadStudentData();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(StudentUserId))
        {
            await LoadStudentData();
        }
    }

    private async Task LoadStudentData()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Check if StudentUserId is provided
            if (string.IsNullOrEmpty(StudentUserId))
            {
                errorMessage = "Student ID không được cung cấp";
                return;
            }

            Console.WriteLine($"Loading data for student: {StudentUserId}");

            // Load student information
            student = await _atlasApiClient.GetUserAsync(StudentUserId);
            if (student == null)
            {
                errorMessage = $"Không tìm thấy thông tin học sinh với ID: {StudentUserId}";
                return;
            }

            Console.WriteLine($"Loaded student: {student.FullName}");

            // Load device status
            var deviceStatusObj = await _atlasApiClient.GetDevicesStatusByUserAsync(StudentUserId);
            if (deviceStatusObj != null)
            {
                try
                {
                    string json;
                    
                    // Handle different types of response objects
                    if (deviceStatusObj is JsonElement jsonElement)
                    {
                        json = jsonElement.GetRawText();
                    }
                    else
                    {
                        json = JsonSerializer.Serialize(deviceStatusObj);
                    }
                    
                    Console.WriteLine($"Raw device status JSON: {json}");
                    
                    // Parse JSON with custom options
                    var options = new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true,
                        PropertyNamingPolicy = JsonNamingPolicy.CamelCase
                    };
                    
                    deviceStatus = JsonSerializer.Deserialize<DeviceStatusSummary>(json, options);
                    
                    if (deviceStatus != null)
                    {
                        Console.WriteLine($"Loaded device status: {deviceStatus.TotalDevices} total, {deviceStatus.OnlineDevices} online, {deviceStatus.OfflineDevices} offline");
                        
                        if (deviceStatus.Devices != null && deviceStatus.Devices.Any())
                        {
                            foreach (var device in deviceStatus.Devices)
                            {
                                Console.WriteLine($"Device: {device.DeviceId} ({device.Model}) - Status: {device.Status} - LastSync: {device.LastSyncAt}");
                            }
                        }
                        else
                        {
                            Console.WriteLine("No devices found in device status");
                        }
                    }
                    else
                    {
                        Console.WriteLine("Failed to deserialize device status");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error parsing device status: {ex.Message}");
                    deviceStatus = null;
                }
            }
            else
            {
                Console.WriteLine("No device status returned from API");
            }

            // Load sensor readings with date range
            var fromDate = DateTimeOffset.UtcNow.AddDays(-30); // Get last 30 days
            var toDate = DateTimeOffset.UtcNow.AddDays(1);

            var readingsData = await _atlasApiClient.GetSensorReadingsByDateRangeAsync(StudentUserId, fromDate, toDate);
            if (readingsData != null && readingsData.Any())
            {
                sensorReadings = readingsData;
                Console.WriteLine($"Loaded {readingsData.Count} sensor readings from date range");
            }
            else
            {
                // Try to get latest readings if date range returns empty
                var latestReadings = await _atlasApiClient.GetLatestSensorReadingsByUserAsync(StudentUserId, 100);
                if (latestReadings != null && latestReadings.Any())
                {
                    sensorReadings = latestReadings;
                    Console.WriteLine($"Loaded {latestReadings.Count} latest sensor readings");
                }
                else
                {
                    Console.WriteLine("No sensor readings found for user");
                    sensorReadings = new List<SensorReadingInfoDto>();
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tải dữ liệu: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void GoBack()
    {
        _navigationManager.NavigateTo("/dalyhealth/mainview");
    }

    private async Task RefreshData()
    {
        await LoadStudentData();
    }

    private (bool IsOnline, bool HasDevices, string LastSync) GetDeviceStatus()
    {
        if (deviceStatus == null)
        {
            return (false, false, "Chưa có dữ liệu");
        }

        var hasDevices = deviceStatus.TotalDevices > 0;
        if (!hasDevices)
        {
            return (false, false, "Chưa có dữ liệu");
        }

        var isOnline = deviceStatus.OnlineDevices > 0;
        
        // Parse LastSyncAt from ISO 8601 string to DateTime and format
        var lastSyncString = "Chưa đồng bộ";
        var firstDevice = deviceStatus.Devices?.FirstOrDefault();
        if (firstDevice?.LastSyncAt != null && !string.IsNullOrEmpty(firstDevice.LastSyncAt))
        {
            if (DateTime.TryParse(firstDevice.LastSyncAt, out DateTime lastSyncDate))
            {
                // Convert to local time zone (Vietnam)
                var timeZone = TimeZoneInfo.FindSystemTimeZoneById("SE Asia Standard Time");
                var localTime = TimeZoneInfo.ConvertTime(lastSyncDate, timeZone);
                lastSyncString = localTime.ToString("HH:mm dd/MM/yyyy");
            }
            else
            {
                lastSyncString = "Lỗi định dạng thời gian";
            }
        }

        return (isOnline, hasDevices, lastSyncString);
    }

    private HealthMetrics GetHealthMetrics()
    {
        if (!sensorReadings.Any())
        {
            return new HealthMetrics();
        }

        sensorReadings.Sort((a, b) => a.Timestamp.CompareTo(b.Timestamp));

        // Get readings from last 7 days instead of just today for more data


        // Process all readings and extract metrics
        var healthMetrics = new HealthMetrics();
        var heartRateReadings = new List<SensorReadingInfoDto>();
        var stepsReadings = new List<SensorReadingInfoDto>();
        var sleepReadings = new List<SensorReadingInfoDto>();
        var calorieReadings = new List<SensorReadingInfoDto>();

        foreach (var reading in sensorReadings)
        {
            var sensorType = reading.Metadata?.SensorType?.ToLower();

            // Process based on sensor type
            switch (sensorType)
            {
                case "heart_rate":
                case "heart_rate_monitor":
                case "pulse":
                    heartRateReadings.Add(reading);
                    ProcessHeartRateReading(reading, healthMetrics);
                    break;

                case "activity":
                case "step_counter":
                case "step_count":
                case "steps":
                    stepsReadings.Add(reading);
                    ProcessStepsReading(reading, healthMetrics);
                    break;

                case "sleep":
                case "sleep_tracker":
                case "sleep_duration":
                    sleepReadings.Add(reading);
                    ProcessSleepReading(reading, healthMetrics);
                    break;

                case "calories":
                case "calorie_tracker":
                case "calories_burned":
                case "energy":
                    calorieReadings.Add(reading);
                    ProcessCaloriesReading(reading, healthMetrics);
                    break;

                default:
                    // Try to process as generic data
                    ProcessGenericReading(reading, healthMetrics, heartRateReadings, stepsReadings, sleepReadings, calorieReadings);
                    break;
            }
        }

        // Set the readings collections
        healthMetrics.HeartRateReadings = heartRateReadings;
        healthMetrics.StepsReadings = stepsReadings;
        healthMetrics.SleepReadings = sleepReadings;
        healthMetrics.CalorieReadings = calorieReadings;

        return healthMetrics;
    }

    private void ProcessHeartRateReading(SensorReadingInfoDto reading, HealthMetrics healthMetrics)
    {
        foreach (var data in reading.Readings)
        {
            if (data.Key?.ToLower().Contains("heart") == true ||
            data.Key?.ToLower().Contains("bpm") == true ||
            data.Key?.ToLower().Contains("pulse") == true)
            {
                var value = GetNumericValue(data.Value);
                if (value > 0 && value < 300) // Reasonable heart rate range
                {
                    healthMetrics.HeartRate = value;
                    Console.WriteLine($"Found heart rate: {value} from key: {data.Key}");
                }
            }
            break;
        }
    }

    private void ProcessStepsReading(SensorReadingInfoDto reading, HealthMetrics healthMetrics)
    {
        foreach (var data in reading.Readings)
        {
            if (data.Key?.ToLower().Contains("step") == true || data.Key?.ToLower().Contains("count") == true)
            {
                var value = GetNumericValue(data.Value);
                if (value > 0)
                {
                    healthMetrics.Steps = (int)value;
                    Console.WriteLine($"Found steps: {value} from key: {data.Key}");
                }
            }
            break;
        }

    }

    private void ProcessSleepReading(SensorReadingInfoDto reading, HealthMetrics healthMetrics)
    {
        foreach (var data in reading.Readings)
        {
            if (data.Key?.ToLower().Contains("sleep") == true ||
            data.Key?.ToLower().Contains("sleep_duration_minutes") == true)
            {
                var value = GetNumericValue(data.Value);
                if (value > 0)
                {
                    // Convert minutes to hours if needed
                    var hours = Math.Round(value / 60.0, 1);
                    healthMetrics.Sleep = hours;
                    Console.WriteLine($"Found sleep: {hours} hours (original: {value}) from key: {data.Key}");
                }
            }
            break;
        }

    }

    private void ProcessCaloriesReading(SensorReadingInfoDto reading, HealthMetrics healthMetrics)
    {
        foreach (var data in reading.Readings)
        {
            if (data.Key?.ToLower().Contains("calorie") == true || data.Key?.ToLower().Contains("energy") == true)
            {
                var value = GetNumericValue(data.Value);
                if (value > 0)
                {
                    healthMetrics.Calories = (int)value;
                    Console.WriteLine($"Found calories: {value} from key: {data.Key}");
                }
            }
            break;
        }

    }

    private void ProcessGenericReading(SensorReadingInfoDto reading, HealthMetrics healthMetrics,
    List<SensorReadingInfoDto> heartRateReadings, List<SensorReadingInfoDto> stepsReadings,
    List<SensorReadingInfoDto> sleepReadings, List<SensorReadingInfoDto> calorieReadings)
    {
        foreach (var data in reading.Readings)
        {
            var key = data.Key?.ToLower() ?? "";
            var value = GetNumericValue(data.Value);

            if (value <= 0) continue;

            if (key.Contains("step"))
            {
                healthMetrics.Steps = (int)value;
                if (!stepsReadings.Contains(reading)) stepsReadings.Add(reading);
            }
            else if (key.Contains("calorie"))
            {
                healthMetrics.Calories = (int)value;
                if (!calorieReadings.Contains(reading)) calorieReadings.Add(reading);
            }
            else if (key.Contains("heart") || key.Contains("bpm"))
            {
                if (value < 300)
                {
                    healthMetrics.HeartRate = value;
                    if (!heartRateReadings.Contains(reading)) heartRateReadings.Add(reading);
                }
            }
            else if (key.Contains("sleep"))
            {
                var hours = Math.Round(value / 60.0, 1);
                healthMetrics.Sleep = hours;
                if (!sleepReadings.Contains(reading)) sleepReadings.Add(reading);
            }
        }
    }

    private double GetLatestValue(List<SensorReadingInfoDto> readings)
    {
        if (!readings.Any()) return 0;

        // Sort by timestamp to get the latest reading
        var latest = readings.OrderByDescending(r => r.Timestamp).FirstOrDefault();
        if (latest?.Readings.Any() == true)
        {
            // Process each reading to find the best value
            foreach (var data in latest.Readings)
            {
                var key = data.Key?.ToLower() ?? "";
                var value = GetNumericValue(data.Value);

                if (value > 0)
                {
                    // Check for specific key patterns that indicate main values
                    if (key.Contains("step") || key.Contains("count") ||
                    key.Contains("calorie") || key.Contains("energy") ||
                    key.Contains("heart") || key.Contains("bpm") || key.Contains("pulse") ||
                    key.Contains("sleep") || key.Contains("duration") ||
                    key.Equals("value") || key.Equals("val") || key.Equals("data") ||
                    key.Contains("spo2_percentage"))
                    {
                        return value;
                    }
                }
            }

            // If no specific key patterns found, try to get any valid numeric value
            foreach (var data in latest.Readings)
            {
                var value = GetNumericValue(data.Value);
                if (value > 0)
                {
                    return value;
                }
            }
        }
        return 0;
    }

    private double GetNumericValue(object? value)
    {
        if (value == null) return 0;

        try
        {
            if (value is JsonElement jsonElement)
            {
                return jsonElement.ValueKind switch
                {
                    JsonValueKind.Number => jsonElement.GetDouble(),
                    JsonValueKind.String => double.TryParse(jsonElement.GetString(), out var result) ? result : 0,
                    _ => 0
                };
            }
            else if (value is string stringValue)
            {
                return double.TryParse(stringValue, out var result) ? result : 0;
            }
            else
            {
                return Convert.ToDouble(value);
            }
        }
        catch
        {
            return 0;
        }
    }

    private double GetTrend(List<SensorReadingInfoDto> readings)
    {
        if (readings.Count < 2) return 0;

        var first = GetLatestValue(readings.Take(1).ToList());
        var last = GetLatestValue(readings.TakeLast(1).ToList());

        return last - first;
    }

    // Heart Rate Status Methods
    private string GetHeartRateStatus(double heartRate)
    {
        if (heartRate == 0) return "no-data";
        if (heartRate < 60) return "warning";
        if (heartRate > 100) return "danger";
        return "normal";
    }

    private string GetHeartRateStatusText(double heartRate)
    {
        if (heartRate == 0) return "Chưa có dữ liệu";
        if (heartRate < 60) return "Thấp";
        if (heartRate > 100) return "Cao";
        return "Bình thường";
    }

    // Steps Status Methods
    private string GetStepsStatus(int steps)
    {
        if (steps == 0) return "no-data";
        if (steps < 5000) return "warning";
        if (steps >= 10000) return "excellent";
        if (steps >= 7000) return "good";
        return "average";
    }

    private string GetStepsStatusText(int steps)
    {
        if (steps == 0) return "Chưa có dữ liệu";
        if (steps < 5000) return "Cần cải thiện";
        if (steps >= 10000) return "Xuất sắc";
        if (steps >= 7000) return "Tốt";
        return "Trung bình";
    }

    // Sleep Status Methods
    private string GetSleepStatus(double sleep)
    {
        if (sleep == 0) return "no-data";
        if (sleep < 6) return "warning";
        if (sleep > 9) return "warning";
        if (sleep >= 7 && sleep <= 8) return "excellent";
        return "good";
    }

    private string GetSleepStatusText(double sleep)
    {
        if (sleep == 0) return "Chưa có dữ liệu";
        if (sleep < 6) return "Thiếu ngủ";
        if (sleep > 9) return "Ngủ quá nhiều";
        if (sleep >= 7 && sleep <= 8) return "Lý tưởng";
        return "Tốt";
    }

    private string GetSleepQuality(double sleep)
    {
        if (sleep == 0) return "Chưa có dữ liệu";
        if (sleep < 6) return "Kém";
        if (sleep > 9) return "Quá nhiều";
        if (sleep >= 7 && sleep <= 8) return "Tốt";
        return "Khá";
    }

    private int GetSleepQualityScore(double sleep)
    {
        if (sleep == 0) return 0;
        if (sleep < 5) return 40;
        if (sleep < 6) return 60;
        if (sleep >= 7 && sleep <= 8) return 90;
        if (sleep >= 6 && sleep < 7) return 75;
        if (sleep > 8 && sleep <= 9) return 80;
        return 50;
    }

    // Calories Status Methods
    private string GetCaloriesStatus(int calories)
    {
        if (calories == 0) return "no-data";
        if (calories < 1200) return "warning";
        if (calories >= 2000) return "excellent";
        if (calories >= 1500) return "good";
        return "average";
    }

    private string GetCaloriesStatusText(int calories)
    {
        if (calories == 0) return "Chưa có dữ liệu";
        if (calories < 1200) return "Quá thấp";
        if (calories >= 2000) return "Tốt";
        if (calories >= 1500) return "Khá tốt";
        return "Trung bình";
    }

    private string GetDeviceDisplayName(string model)
    {
        if (string.IsNullOrEmpty(model)) return "Unknown Device";
        
        // Common Samsung device mappings
        var deviceMappings = new Dictionary<string, string>
        {
            {"SM-G970F", "Samsung Galaxy S10e"},
            {"SM-G973F", "Samsung Galaxy S10"},
            {"SM-G975F", "Samsung Galaxy S10+"},
            {"SM-G977B", "Samsung Galaxy S10 5G"},
            {"SM-N970F", "Samsung Galaxy Note10"},
            {"SM-N975F", "Samsung Galaxy Note10+"},
            {"SM-G980F", "Samsung Galaxy S20"},
            {"SM-G981B", "Samsung Galaxy S20 5G"},
            {"SM-G985F", "Samsung Galaxy S20+"},
            {"SM-G986B", "Samsung Galaxy S20+ 5G"},
            {"SM-G988B", "Samsung Galaxy S20 Ultra 5G"},
            {"SM-G991B", "Samsung Galaxy S21 5G"},
            {"SM-G996B", "Samsung Galaxy S21+ 5G"},
            {"SM-G998B", "Samsung Galaxy S21 Ultra 5G"},
            {"SM-A515F", "Samsung Galaxy A51"},
            {"SM-A715F", "Samsung Galaxy A71"},
            {"SM-A525F", "Samsung Galaxy A52"},
            {"SM-A725F", "Samsung Galaxy A72"}
        };
        
        if (deviceMappings.TryGetValue(model, out string? displayName))
        {
            return displayName;
        }
        
        // If not found in mappings, try to make it more readable
        if (model.StartsWith("SM-"))
        {
            return $"Samsung {model}";
        }
        
        return model;
    }

    private class HealthMetrics
    {
        public double HeartRate { get; set; }
        public int Steps { get; set; }
        public double Sleep { get; set; }
        public int Calories { get; set; }
        public List<SensorReadingInfoDto> HeartRateReadings { get; set; } = new();
        public List<SensorReadingInfoDto> StepsReadings { get; set; } = new();
        public List<SensorReadingInfoDto> SleepReadings { get; set; } = new();
        public List<SensorReadingInfoDto> CalorieReadings { get; set; } = new();
    }

    private class DeviceStatusSummary
    {
        public string UserId { get; set; } = string.Empty;
        public int TotalDevices { get; set; }
        public int OnlineDevices { get; set; }
        public int OfflineDevices { get; set; }
        public List<DeviceInfo> Devices { get; set; } = new();
    }

    private class DeviceInfo
    {
        public string DeviceId { get; set; } = string.Empty;
        public string Model { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public string SdkVersion { get; set; } = string.Empty;
        public string OsVersion { get; set; } = string.Empty;
        public string LastSyncAt { get; set; } = string.Empty; // ISO 8601 string
        public string RegisteredAt { get; set; } = string.Empty; // ISO 8601 string
        public bool IsOnline { get; set; }
    }

    // New properties and methods for health statistics
    private string selectedPeriod = "today";

    private void ChangePeriod(string period)
    {
        selectedPeriod = period;
        StateHasChanged();
    }

    private string GetPeriodLabel(string period)
    {
        return period switch
        {
            "today" => "hôm nay",
            "week" => "7 ngày qua",
            "2weeks" => "2 tuần qua",
            "month" => "30 ngày qua",
            _ => "hôm nay"
        };
    }

    private int GetPeriodDays(string period)
    {
        return period switch
        {
            "today" => 1,
            "week" => 7,
            "2weeks" => 14,
            "month" => 30,
            _ => 1
        };
    }

    private HealthStatistics GetHealthStatsByPeriod(string period)
    {
        var days = GetPeriodDays(period);
        var fromDate = DateTimeOffset.UtcNow.AddDays(-days);
        var toDate = DateTimeOffset.UtcNow;

        // Filter readings by date range
        var periodReadings = sensorReadings.Where(r => r.Timestamp >= fromDate && r.Timestamp <= toDate).ToList();

        if (!periodReadings.Any())
        {
            return new HealthStatistics();
        }

        // Calculate current values (latest readings)
        var currentHealthMetrics = GetHealthMetrics();

        // Calculate averages and statistics
        var dailyStats = GetDailyStatistics(periodReadings, days);

        return new HealthStatistics
        {
            CurrentSteps = currentHealthMetrics.Steps,
            CurrentHeartRate = currentHealthMetrics.HeartRate,
            CurrentCalories = currentHealthMetrics.Calories,
            CurrentSleep = currentHealthMetrics.Sleep,

            // Calculate averages excluding zero values
            AvgSteps = dailyStats.Where(d => d.Steps > 0).Any() ? 
                (int)dailyStats.Where(d => d.Steps > 0).Average(d => d.Steps) : 0,
            AvgHeartRate = dailyStats.Where(d => d.HeartRate > 0).Any() ? 
                dailyStats.Where(d => d.HeartRate > 0).Average(d => d.HeartRate) : 0,
            AvgCalories = dailyStats.Where(d => d.Calories > 0).Any() ? 
                (int)dailyStats.Where(d => d.Calories > 0).Average(d => d.Calories) : 0,
            AvgSleep = dailyStats.Where(d => d.Sleep > 0).Any() ? 
                dailyStats.Where(d => d.Sleep > 0).Average(d => d.Sleep) : 0,

            // Min/Max for heart rate excluding zeros
            MinHeartRate = dailyStats.Where(d => d.HeartRate > 0).Any() ? 
                dailyStats.Where(d => d.HeartRate > 0).Min(d => d.HeartRate) : 0,
            MaxHeartRate = dailyStats.Where(d => d.HeartRate > 0).Any() ? 
                dailyStats.Where(d => d.HeartRate > 0).Max(d => d.HeartRate) : 0,
            AvgRestingHeartRate = dailyStats.Where(d => d.HeartRate > 0).Any() ? 
                dailyStats.Where(d => d.HeartRate > 0).Average(d => d.HeartRate) : 0,

            TotalSteps = dailyStats.Sum(d => d.Steps),
            TotalCalories = dailyStats.Sum(d => d.Calories),

            DaysWithData = dailyStats.Count(d => d.HasValidData()),
            DaysWithStepsGoal = dailyStats.Count(d => d.Steps >= 6000)
        };
    }

    private List<DailyStat> GetDailyStatistics(List<SensorReadingInfoDto> readings, int days)
    {
        var dailyStats = new List<DailyStat>();
        var startDate = DateTimeOffset.UtcNow.AddDays(-days).Date;

        for (int i = 0; i < days; i++)
        {
            var currentDate = startDate.AddDays(i);
            var dayReadings = readings.Where(r => r.Timestamp.Date == currentDate).ToList();

            var dailyStat = new DailyStat
            {
                Date = currentDate,
                HasData = dayReadings.Any()
            };

            if (dayReadings.Any())
            {
                // Process daily readings
                var dayMetrics = ProcessDayReadings(dayReadings);
                dailyStat.Steps = dayMetrics.Steps;
                dailyStat.HeartRate = dayMetrics.HeartRate;
                dailyStat.Calories = dayMetrics.Calories;
                dailyStat.Sleep = dayMetrics.Sleep;
                
                // Only consider it a good day if we have valid data and meet criteria
                dailyStat.IsGoodDay = dailyStat.HasValidData() && 
                                      (dayMetrics.Steps >= 6000 || dayMetrics.Sleep >= 6);
            }

            dailyStats.Add(dailyStat);
        }

        return dailyStats;
    }

    private HealthMetrics ProcessDayReadings(List<SensorReadingInfoDto> dayReadings)
    {
        var healthMetrics = new HealthMetrics();

        foreach (var reading in dayReadings)
        {
            var sensorType = reading.Metadata?.SensorType?.ToLower();
            
            switch (sensorType)
            {
                case "heart_rate":
                case "heart_rate_monitor":
                case "pulse":
                    ProcessHeartRateReading(reading, healthMetrics);
                    break;
                case "activity":
                case "step_counter":
                case "step_count":
                case "steps":
                    ProcessStepsReading(reading, healthMetrics);
                    break;
                case "sleep":
                case "sleep_tracker":
                case "sleep_duration":
                    ProcessSleepReading(reading, healthMetrics);
                    break;
                case "calories":
                case "calorie_tracker":
                case "calories_burned":
                case "energy":
                    ProcessCaloriesReading(reading, healthMetrics);
                    break;
                default:
                    ProcessGenericReading(reading, healthMetrics, new(), new(), new(), new());
                    break;
            }
        }

        return healthMetrics;
    }

    private List<DailyStat> GetDailyBreakdown(string period)
    {
        var days = GetPeriodDays(period);
        var fromDate = DateTimeOffset.UtcNow.AddDays(-days);
        var periodReadings = sensorReadings.Where(r => r.Timestamp >= fromDate).ToList();
        
        return GetDailyStatistics(periodReadings, days)
            .Where(d => d.HasValidData()) // Only include days with actual data (non-zero values)
            .OrderByDescending(d => d.Date)
            .Take(14) // Limit to last 14 days for display
            .ToList();
    }

    private class HealthStatistics
    {
        public int CurrentSteps { get; set; }
        public double CurrentHeartRate { get; set; }
        public int CurrentCalories { get; set; }
        public double CurrentSleep { get; set; }

        public int AvgSteps { get; set; }
        public double AvgHeartRate { get; set; }
        public int AvgCalories { get; set; }
        public double AvgSleep { get; set; }

        public double MinHeartRate { get; set; }
        public double MaxHeartRate { get; set; }
        public double AvgRestingHeartRate { get; set; }

        public int TotalSteps { get; set; }
        public int TotalCalories { get; set; }

        public int DaysWithData { get; set; }
        public int DaysWithStepsGoal { get; set; }
    }

    private class DailyStat
    {
        public DateTime Date { get; set; }
        public int Steps { get; set; }
        public double HeartRate { get; set; }
        public int Calories { get; set; }
        public double Sleep { get; set; }
        public bool HasData { get; set; }
        public bool IsGoodDay { get; set; }

        // Method to check if this day has any valid data (non-zero values)
        public bool HasValidData()
        {
            return Steps > 0 || HeartRate > 0 || Calories > 0 || Sleep > 0;
        }

        // Method to check if the day has sufficient data for meaningful analysis
        public bool HasSufficientData()
        {
            int validMetrics = 0;
            if (Steps > 0) validMetrics++;
            if (HeartRate > 0) validMetrics++;
            if (Calories > 0) validMetrics++;
            if (Sleep > 0) validMetrics++;
            
            return validMetrics >= 2; // At least 2 valid metrics
        }
    }

    // Weekly Statistics and Insights Classes
    private class WeeklyStatistics
    {
        public int TotalSteps { get; set; }
        public int TotalCalories { get; set; }
        public double AvgHeartRate { get; set; }
        public double AvgSleep { get; set; }
        public double StepsChange { get; set; }
        public double CaloriesChange { get; set; }
        public double HeartRateChange { get; set; }
        public double SleepChange { get; set; }
    }

    private class HealthInsight
    {
        public string Type { get; set; } = string.Empty; // positive, warning, info
        public string Icon { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string Message { get; set; } = string.Empty;
    }

    private class HealthGoals
    {
        public int CurrentSteps { get; set; }
        public int StepsGoal { get; set; } = 8000;
        public int StepsProgress => StepsGoal > 0 ? Math.Min((CurrentSteps * 100) / StepsGoal, 100) : 0;
        public int StepsAchievedDays { get; set; }

        public int CurrentCalories { get; set; }
        public int CaloriesGoal { get; set; } = 2000;
        public int CaloriesProgress => CaloriesGoal > 0 ? Math.Min((CurrentCalories * 100) / CaloriesGoal, 100) : 0;

        public double CurrentSleep { get; set; }
        public double SleepGoal { get; set; } = 8.0;
        public int SleepProgress => SleepGoal > 0 ? Math.Min((int)((CurrentSleep * 100) / SleepGoal), 100) : 0;

        public int ActiveDays { get; set; }
        public int WeeklyActivityProgress => (ActiveDays * 100) / 7;
    }

    // Methods for Weekly Statistics
    private WeeklyStatistics GetWeeklyStatistics()
    {
        var currentWeekStart = DateTimeOffset.UtcNow.AddDays(-7);
        var previousWeekStart = DateTimeOffset.UtcNow.AddDays(-14);
        var previousWeekEnd = DateTimeOffset.UtcNow.AddDays(-7);

        // Current week data
        var currentWeekReadings = sensorReadings.Where(r => r.Timestamp >= currentWeekStart).ToList();
        var currentWeekStats = GetWeekStatsSummary(currentWeekReadings);

        // Previous week data  
        var previousWeekReadings = sensorReadings.Where(r => r.Timestamp >= previousWeekStart && r.Timestamp < previousWeekEnd).ToList();
        var previousWeekStats = GetWeekStatsSummary(previousWeekReadings);

        return new WeeklyStatistics
        {
            TotalSteps = currentWeekStats.TotalSteps,
            TotalCalories = currentWeekStats.TotalCalories,
            AvgHeartRate = currentWeekStats.AvgHeartRate,
            AvgSleep = currentWeekStats.AvgSleep,
            StepsChange = CalculatePercentageChange(previousWeekStats.TotalSteps, currentWeekStats.TotalSteps),
            CaloriesChange = CalculatePercentageChange(previousWeekStats.TotalCalories, currentWeekStats.TotalCalories),
            HeartRateChange = previousWeekStats.AvgHeartRate > 0 ? currentWeekStats.AvgHeartRate - previousWeekStats.AvgHeartRate : 0,
            SleepChange = previousWeekStats.AvgSleep > 0 ? currentWeekStats.AvgSleep - previousWeekStats.AvgSleep : 0
        };
    }

    private (int TotalSteps, int TotalCalories, double AvgHeartRate, double AvgSleep) GetWeekStatsSummary(List<SensorReadingInfoDto> readings)
    {
        if (!readings.Any()) return (0, 0, 0, 0);

        var dailyStats = new List<DailyStat>();
        var dates = readings.Select(r => r.Timestamp.Date).Distinct().OrderBy(d => d);

        foreach (var date in dates)
        {
            var dayReadings = readings.Where(r => r.Timestamp.Date == date).ToList();
            var dayMetrics = ProcessDayReadings(dayReadings);
            
            dailyStats.Add(new DailyStat
            {
                Date = date,
                Steps = dayMetrics.Steps,
                HeartRate = dayMetrics.HeartRate,
                Calories = dayMetrics.Calories,
                Sleep = dayMetrics.Sleep
            });
        }

        return (
            dailyStats.Sum(d => d.Steps),
            dailyStats.Sum(d => d.Calories),
            dailyStats.Where(d => d.HeartRate > 0).Any() ? dailyStats.Where(d => d.HeartRate > 0).Average(d => d.HeartRate) : 0,
            dailyStats.Where(d => d.Sleep > 0).Any() ? dailyStats.Where(d => d.Sleep > 0).Average(d => d.Sleep) : 0
        );
    }

    private double CalculatePercentageChange(double oldValue, double newValue)
    {
        if (oldValue == 0) return newValue > 0 ? 100 : 0;
        return ((newValue - oldValue) / oldValue) * 100;
    }

    // Methods for Health Insights
    private List<HealthInsight> GetHealthInsights()
    {
        var insights = new List<HealthInsight>();
        var weeklyStats = GetWeeklyStatistics();
        var currentMetrics = GetHealthMetrics();

        // Steps insights
        if (weeklyStats.TotalSteps > 0)
        {
            var avgDailySteps = weeklyStats.TotalSteps / 7;
            if (avgDailySteps >= 8000)
            {
                insights.Add(new HealthInsight
                {
                    Type = "positive",
                    Icon = "thumbs-up",
                    Title = "Hoạt động tuyệt vời",
                    Message = $"Trung bình {avgDailySteps:N0} bước/ngày. Bạn đang duy trì mức hoạt động tốt cho sức khỏe!"
                });
            }
            else if (avgDailySteps >= 5000)
            {
                insights.Add(new HealthInsight
                {
                    Type = "warning",
                    Icon = "exclamation-triangle",
                    Title = "Cần tăng hoạt động",
                    Message = $"Trung bình {avgDailySteps:N0} bước/ngày. Hãy cố gắng đạt mục tiêu 8000 bước để cải thiện sức khỏe."
                });
            }
            else
            {
                insights.Add(new HealthInsight
                {
                    Type = "warning",
                    Icon = "exclamation-triangle",
                    Title = "Hoạt động thấp",
                    Message = "Mức độ hoạt động còn thấp. Hãy bắt đầu với những bước đi ngắn và tăng dần."
                });
            }
        }

        // Sleep insights
        if (weeklyStats.AvgSleep > 0)
        {
            if (weeklyStats.AvgSleep >= 7 && weeklyStats.AvgSleep <= 9)
            {
                insights.Add(new HealthInsight
                {
                    Type = "positive",
                    Icon = "bed",
                    Title = "Giấc ngủ chất lượng",
                    Message = $"Trung bình {FormatSleepTime(weeklyStats.AvgSleep)} mỗi đêm. Thời gian ngủ lý tưởng cho sức khỏe!"
                });
            }
            else if (weeklyStats.AvgSleep < 6)
            {
                insights.Add(new HealthInsight
                {
                    Type = "warning",
                    Icon = "exclamation-triangle",
                    Title = "Thiếu ngủ",
                    Message = "Thời gian ngủ chưa đủ. Hãy cố gắng ngủ sớm hơn để đảm bảo 7-8 giờ ngủ mỗi đêm."
                });
            }
            else if (weeklyStats.AvgSleep > 9)
            {
                insights.Add(new HealthInsight
                {
                    Type = "info",
                    Icon = "info-circle",
                    Title = "Ngủ nhiều",
                    Message = "Bạn ngủ khá nhiều. Hãy chú ý chất lượng giấc ngủ và hoạt động trong ngày."
                });
            }
        }

        // Heart rate insights
        if (weeklyStats.AvgHeartRate > 0)
        {
            if (weeklyStats.AvgHeartRate >= 60 && weeklyStats.AvgHeartRate <= 100)
            {
                insights.Add(new HealthInsight
                {
                    Type = "positive",
                    Icon = "heart",
                    Title = "Nhịp tim ổn định",
                    Message = $"Nhịp tim trung bình {weeklyStats.AvgHeartRate:0} BPM trong khoảng bình thường."
                });
            }
            else if (weeklyStats.AvgHeartRate < 60)
            {
                insights.Add(new HealthInsight
                {
                    Type = "info",
                    Icon = "heart",
                    Title = "Nhịp tim chậm",
                    Message = "Nhịp tim thấp hơn bình thường. Nếu không phải vận động viên, hãy tham khảo ý kiến bác sĩ."
                });
            }
            else
            {
                insights.Add(new HealthInsight
                {
                    Type = "warning",
                    Icon = "heart",
                    Title = "Nhịp tim cao",
                    Message = "Nhịp tim cao hơn bình thường. Hãy nghỉ ngơi đầy đủ và tham khảo ý kiến bác sĩ nếu cần."
                });
            }
        }

        return insights.Take(3).ToList(); // Limit to 3 insights
    }

    // Methods for Health Goals
    private HealthGoals GetHealthGoals()
    {
        var currentMetrics = GetHealthMetrics();
        var weeklyStats = GetDailyStatistics(sensorReadings.Where(r => r.Timestamp >= DateTimeOffset.UtcNow.AddDays(-7)).ToList(), 7);
        
        return new HealthGoals
        {
            CurrentSteps = currentMetrics.Steps,
            CurrentCalories = currentMetrics.Calories,
            CurrentSleep = currentMetrics.Sleep,
            StepsAchievedDays = weeklyStats.Count(d => d.Steps >= 6000),
            ActiveDays = weeklyStats.Count(d => d.HasValidData())
        };
    }

    // Helper methods for display
    private string GetChangeClass(double change)
    {
        if (change > 5) return "positive";
        if (change < -5) return "negative";
        return "neutral";
    }

    private string GetChangeIcon(double change)
    {
        if (change > 5) return "arrow-up";
        if (change < -5) return "arrow-down";
        return "minus";
    }

    private string GetChangeText(double change, string unit, bool isHeartRate = false)
    {
        if (Math.Abs(change) < 0.1) return "Không đổi";
        
        if (isHeartRate)
        {
            return change > 0 ? $"+{change:0.1} {unit}" : $"{change:0.1} {unit}";
        }
        
        if (Math.Abs(change) < 1)
        {
            return change > 0 ? $"+{change:0.1}% {unit}" : $"{change:0.1}% {unit}";
        }
        
        return change > 0 ? $"+{change:0}% {unit}" : $"{change:0}% {unit}";
    }

    private string GetSleepChangeText(double change)
    {
        if (Math.Abs(change) < 0.1) return "Không đổi";
        
        var minutes = Math.Abs(change) * 60;
        var sign = change > 0 ? "+" : "-";
        
        if (minutes >= 60)
        {
            var hours = minutes / 60;
            return $"{sign}{hours:0.1} giờ";
        }
        else
        {
            return $"{sign}{minutes:0} phút";
        }
    }

    private string FormatSleepTime(double hours)
    {
        if (hours <= 0) return "--";
        
        var h = (int)hours;
        var m = (int)((hours - h) * 60);
        return $"{h}h {m:00}m";
    }

    private string GetGoalStatusClass(int value, int threshold)
    {
        return value >= threshold ? "achieved" : "in-progress";
    }

    private string GetGoalStatusClass(double percentage, double threshold)
    {
        return percentage >= threshold ? "achieved" : "in-progress";
    }

    private string GetStepsGoalStatus(int achievedDays)
    {
        if (achievedDays >= 6) return "Xuất sắc";
        if (achievedDays >= 4) return $"Đã đạt {achievedDays}/7 ngày";
        return "Cần cải thiện";
    }

    private string GetCaloriesGoalStatus(int percentage)
    {
        if (percentage >= 90) return "Đạt mục tiêu";
        if (percentage >= 70) return "Đang tiến bộ";
        return "Cần cải thiện";
    }

    private string GetSleepGoalStatus(int percentage)
    {
        if (percentage >= 95) return "Lý tưởng";
        if (percentage >= 80) return "Gần đạt mục tiêu";
        return "Cần cải thiện";
    }

    private string GetActivityGoalStatus(int activeDays)
    {
        if (activeDays >= 6) return "Tuyệt vời";
        if (activeDays >= 4) return $"{activeDays}/7 ngày";
        return "Cần cải thiện";
    }
    # region Health Report Generation
    // Health Report Generation
    private async Task GenerateHealthReport()
    {
        if (student == null || isGeneratingReport) return;

        try
        {
            isGeneratingReport = true;
            StateHasChanged();

            var reportData = await GenerateHealthReportData();
            var htmlContent = GenerateHealthReportHtml(reportData);
            await DownloadHtmlReport(htmlContent, $"BaoCaoSucKhoe_{student.FullName}_{DateTime.Now:yyyyMMdd}.html");
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi khi tạo báo cáo: {ex.Message}";
        }
        finally
        {
            isGeneratingReport = false;
            StateHasChanged();
        }
    }

    private Task<HealthReportData> GenerateHealthReportData()
    {
        var currentMetrics = GetHealthMetrics();
        var weeklyStats = GetWeeklyStatistics();
        var monthlyStats = GetHealthStatsByPeriod("month");
        var insights = GetHealthInsights();
        var goals = GetHealthGoals();
        
        // Get 30-day daily breakdown
        var thirtyDayReadings = sensorReadings.Where(r => r.Timestamp >= DateTimeOffset.UtcNow.AddDays(-30)).ToList();
        var dailyBreakdown = GetDailyStatistics(thirtyDayReadings, 30);
        
        return Task.FromResult(new HealthReportData
        {
            Student = student!,
            GeneratedDate = DateTime.Now,
            ReportPeriod = "30 ngày qua",
            CurrentMetrics = currentMetrics,
            WeeklyStats = weeklyStats,
            MonthlyStats = monthlyStats,
            Insights = insights,
            Goals = goals,
            DailyBreakdown = dailyBreakdown.Where(d => d.HasValidData()).OrderByDescending(d => d.Date).ToList(),
            DeviceStatus = deviceStatus
        });
    }

    private string GenerateHealthReportHtml(HealthReportData data)
    {
        var sb = new StringBuilder();
        
        sb.AppendLine("<!DOCTYPE html>");
        sb.AppendLine("<html lang='vi'>");
        sb.AppendLine("<head>");
        sb.AppendLine("    <meta charset='UTF-8'>");
        sb.AppendLine("    <meta name='viewport' content='width=device-width, initial-scale=1.0'>");
        sb.AppendLine($"    <title>Báo cáo Sức khỏe - {data.Student.FullName}</title>");
        sb.AppendLine("    <style>");
        sb.AppendLine(@"        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 20px;
        }
        .header h1 {
            color: #007bff;
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            color: #666;
            margin: 10px 0 0 0;
            font-size: 1.2em;
        }
        .student-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 5px solid #28a745;
        }
        .student-info h2 {
            color: #28a745;
            margin-top: 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        .info-value {
            color: #6c757d;
        }
        .metrics-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .metric-card {
            background: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metric-card.steps { border-left: 5px solid #10B981; }
        .metric-card.calories { border-left: 5px solid #F59E0B; }
        .metric-card.heart-rate { border-left: 5px solid #EF4444; }
        .metric-card.sleep { border-left: 5px solid #6366F1; }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            color: #6c757d;
            font-weight: 500;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .section h3 {
            color: #495057;
            margin-top: 0;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        .insights-list {
            list-style: none;
            padding: 0;
        }
        .insight-item {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .insight-item.positive { border-left-color: #28a745; }
        .insight-item.warning { border-left-color: #ffc107; }
        .insight-item.info { border-left-color: #17a2b8; }
        .daily-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .daily-table th,
        .daily-table td {
            padding: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .daily-table th {
            background: #007bff;
            color: white;
            font-weight: 600;
        }
        .daily-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .goal-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        .goal-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .progress-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #007bff;
            transition: width 0.3s;
        }
        .progress-fill.steps { background: #10B981; }
        .progress-fill.calories { background: #F59E0B; }
        .progress-fill.sleep { background: #6366F1; }
        .progress-fill.activity { background: #EF4444; }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #dee2e6;
            color: #6c757d;
        }
        @media print {
            body { background: white; }
            .container { box-shadow: none; }
        }");
        sb.AppendLine("    </style>");
        sb.AppendLine("</head>");
        sb.AppendLine("<body>");
        sb.AppendLine("    <div class='container'>");
        
        // Header
        sb.AppendLine("        <div class='header'>");
        sb.AppendLine("            <h1>BÁO CÁO SỨC KHỎE</h1>");
        sb.AppendLine("            <p>Hệ thống Theo dõi Sức khỏe Học sinh</p>");
        sb.AppendLine("        </div>");
        
        // Student Info
        sb.AppendLine("        <div class='student-info'>");
        sb.AppendLine("            <h2>Thông tin Học Viên</h2>");
        sb.AppendLine("            <div class='info-grid'>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Họ và tên:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.Student.FullName}</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Khoa/Phòng:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.Student.Department ?? "N/A"}</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Vai trò:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.Student.Role ?? "N/A"}</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Email:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.Student.Email ?? "N/A"}</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Ngày tạo báo cáo:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.GeneratedDate:dd/MM/yyyy HH:mm}</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Thời gian báo cáo:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.ReportPeriod}</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("            </div>");
        sb.AppendLine("        </div>");
        
        // Current Metrics
        sb.AppendLine("        <div class='metrics-overview'>");
        sb.AppendLine("            <div class='metric-card steps'>");
        sb.AppendLine($"                <div class='metric-value'>{(data.CurrentMetrics.Steps > 0 ? data.CurrentMetrics.Steps.ToString("N0") : "--")}</div>");
        sb.AppendLine("                <div class='metric-label'>Bước chân hiện tại</div>");
        sb.AppendLine("            </div>");
        sb.AppendLine("            <div class='metric-card calories'>");
        sb.AppendLine($"                <div class='metric-value'>{(data.CurrentMetrics.Calories > 0 ? data.CurrentMetrics.Calories.ToString("N0") : "--")}</div>");
        sb.AppendLine("                <div class='metric-label'>Calories hiện tại</div>");
        sb.AppendLine("            </div>");
        sb.AppendLine("            <div class='metric-card heart-rate'>");
        sb.AppendLine($"                <div class='metric-value'>{(data.CurrentMetrics.HeartRate > 0 ? data.CurrentMetrics.HeartRate.ToString("0") + " BPM" : "--")}</div>");
        sb.AppendLine("                <div class='metric-label'>Nhịp tim hiện tại</div>");
        sb.AppendLine("            </div>");
        sb.AppendLine("            <div class='metric-card sleep'>");
        sb.AppendLine($"                <div class='metric-value'>{(data.CurrentMetrics.Sleep > 0 ? FormatSleepTime(data.CurrentMetrics.Sleep) : "--")}</div>");
        sb.AppendLine("                <div class='metric-label'>Giấc ngủ hiện tại</div>");
        sb.AppendLine("            </div>");
        sb.AppendLine("        </div>");
        
        // Monthly Stats
        sb.AppendLine("        <div class='section'>");
        sb.AppendLine("            <h3>Thống kê 30 ngày qua</h3>");
        sb.AppendLine("            <div class='info-grid'>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Tổng bước chân:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.MonthlyStats.TotalSteps:N0} bước</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Trung bình bước/ngày:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.MonthlyStats.AvgSteps:N0} bước</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Tổng calories:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.MonthlyStats.TotalCalories:N0} cal</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Trung bình calories/ngày:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.MonthlyStats.AvgCalories:N0} cal</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Nhịp tim trung bình:</span>");
        sb.AppendLine($"                    <span class='info-value'>{(data.MonthlyStats.AvgHeartRate > 0 ? data.MonthlyStats.AvgHeartRate.ToString("0") + " BPM" : "N/A")}</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Giấc ngủ trung bình:</span>");
        sb.AppendLine($"                    <span class='info-value'>{(data.MonthlyStats.AvgSleep > 0 ? FormatSleepTime(data.MonthlyStats.AvgSleep) : "N/A")}</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Số ngày có dữ liệu:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.MonthlyStats.DaysWithData} ngày</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='info-item'>");
        sb.AppendLine("                    <span class='info-label'>Số ngày đạt mục tiêu bước chân:</span>");
        sb.AppendLine($"                    <span class='info-value'>{data.MonthlyStats.DaysWithStepsGoal} ngày</span>");
        sb.AppendLine("                </div>");
        sb.AppendLine("            </div>");
        sb.AppendLine("        </div>");
        
        // Health Insights
        sb.AppendLine("        <div class='section'>");
        sb.AppendLine("            <h3>Nhận xét Sức khỏe</h3>");
        sb.AppendLine("            <ul class='insights-list'>");
        sb.Append(GenerateInsightsHtml(data.Insights));
        sb.AppendLine("            </ul>");
        sb.AppendLine("        </div>");
        
        // Goals Progress
        sb.AppendLine("        <div class='section'>");
        sb.AppendLine("            <h3>Tiến độ Mục tiêu</h3>");
        sb.AppendLine("            <div class='goals-grid'>");
        sb.AppendLine("                <div class='goal-item'>");
        sb.AppendLine($"                    <div class='goal-title'>Bước chân hàng ngày (Mục tiêu: {data.Goals.StepsGoal:N0})</div>");
        sb.AppendLine("                    <div class='progress-bar'>");
        sb.AppendLine($"                        <div class='progress-fill steps' style='width: {data.Goals.StepsProgress}%'></div>");
        sb.AppendLine("                    </div>");
        sb.AppendLine($"                    <div>{data.Goals.CurrentSteps:N0} / {data.Goals.StepsGoal:N0} bước ({data.Goals.StepsProgress}%)</div>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='goal-item'>");
        sb.AppendLine($"                    <div class='goal-title'>Calories đốt cháy (Mục tiêu: {data.Goals.CaloriesGoal:N0})</div>");
        sb.AppendLine("                    <div class='progress-bar'>");
        sb.AppendLine($"                        <div class='progress-fill calories' style='width: {data.Goals.CaloriesProgress}%'></div>");
        sb.AppendLine("                    </div>");
        sb.AppendLine($"                    <div>{data.Goals.CurrentCalories:N0} / {data.Goals.CaloriesGoal:N0} cal ({data.Goals.CaloriesProgress}%)</div>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='goal-item'>");
        sb.AppendLine($"                    <div class='goal-title'>Thời gian ngủ (Mục tiêu: {FormatSleepTime(data.Goals.SleepGoal)})</div>");
        sb.AppendLine("                    <div class='progress-bar'>");
        sb.AppendLine($"                        <div class='progress-fill sleep' style='width: {data.Goals.SleepProgress}%'></div>");
        sb.AppendLine("                    </div>");
        sb.AppendLine($"                    <div>{(data.Goals.CurrentSleep > 0 ? FormatSleepTime(data.Goals.CurrentSleep) : "N/A")} / {FormatSleepTime(data.Goals.SleepGoal)} ({data.Goals.SleepProgress}%)</div>");
        sb.AppendLine("                </div>");
        sb.AppendLine("                <div class='goal-item'>");
        sb.AppendLine("                    <div class='goal-title'>Hoạt động tuần (Mục tiêu: 7 ngày)</div>");
        sb.AppendLine("                    <div class='progress-bar'>");
        sb.AppendLine($"                        <div class='progress-fill activity' style='width: {data.Goals.WeeklyActivityProgress}%'></div>");
        sb.AppendLine("                    </div>");
        sb.AppendLine($"                    <div>{data.Goals.ActiveDays} / 7 ngày ({data.Goals.WeeklyActivityProgress}%)</div>");
        sb.AppendLine("                </div>");
        sb.AppendLine("            </div>");
        sb.AppendLine("        </div>");
        
        // Daily breakdown table
        sb.AppendLine("        <div class='section'>");
        sb.AppendLine("            <h3>Chi tiết theo ngày (Gần đây nhất)</h3>");
        sb.AppendLine("            <table class='daily-table'>");
        sb.AppendLine("                <thead>");
        sb.AppendLine("                    <tr>");
        sb.AppendLine("                        <th>Ngày</th>");
        sb.AppendLine("                        <th>Bước chân</th>");
        sb.AppendLine("                        <th>Calories</th>");
        sb.AppendLine("                        <th>Nhịp tim (BPM)</th>");
        sb.AppendLine("                        <th>Giấc ngủ</th>");
        sb.AppendLine("                    </tr>");
        sb.AppendLine("                </thead>");
        sb.AppendLine("                <tbody>");
        sb.Append(GenerateDailyTableHtml(data.DailyBreakdown.Take(14)));
        sb.AppendLine("                </tbody>");
        sb.AppendLine("            </table>");
        sb.AppendLine("        </div>");
        
        // Device Status
        sb.Append(GenerateDeviceStatusHtml(data.DeviceStatus));
        
        // Footer
        sb.AppendLine("        <div class='footer'>");
        sb.AppendLine("            <p>Báo cáo này được tạo tự động bởi Hệ thống Theo dõi Sức khỏe Học sinh</p>");
        sb.AppendLine($"            <p>Ngày tạo: {data.GeneratedDate:dd/MM/yyyy HH:mm}</p>");
        sb.AppendLine("        </div>");
        
        sb.AppendLine("    </div>");
        sb.AppendLine("</body>");
        sb.AppendLine("</html>");
        
        return sb.ToString();
    }

    private string GenerateInsightsHtml(List<HealthInsight> insights)
    {
        if (insights == null || !insights.Any())
        {
            return "<li class='insight-item info'><div class='insight-title'>Chưa có đủ dữ liệu</div><div>Cần thêm dữ liệu sức khỏe để đưa ra nhận xét chi tiết.</div></li>";
        }

        var sb = new StringBuilder();
        foreach (var insight in insights)
        {
            sb.AppendLine($"<li class='insight-item {insight.Type.ToLower()}'>");
            sb.AppendLine($"    <div class='insight-title'>{insight.Title}</div>");
            sb.AppendLine($"    <div>{insight.Message}</div>");
            sb.AppendLine("</li>");
        }
        return sb.ToString();
    }

    private string GenerateDailyTableHtml(IEnumerable<DailyStat> dailyStats)
    {
        var sb = new StringBuilder();
        foreach (var stat in dailyStats)
        {
            sb.AppendLine("<tr>");
            sb.AppendLine($"    <td>{stat.Date:dd/MM/yyyy}</td>");
            sb.AppendLine($"    <td>{(stat.Steps > 0 ? stat.Steps.ToString("N0") : "--")}</td>");
            sb.AppendLine($"    <td>{(stat.Calories > 0 ? stat.Calories.ToString("N0") : "--")}</td>");
            sb.AppendLine($"    <td>{(stat.HeartRate > 0 ? stat.HeartRate.ToString("0") : "--")}</td>");
            sb.AppendLine($"    <td>{(stat.Sleep > 0 ? FormatSleepTime(stat.Sleep) : "--")}</td>");
            sb.AppendLine("</tr>");
        }
        return sb.ToString();
    }

    private string GenerateDeviceStatusHtml(DeviceStatusSummary? deviceStatus)
    {
        var sb = new StringBuilder();
        
        if (deviceStatus == null || deviceStatus.TotalDevices == 0)
        {
            sb.AppendLine("<div class='section'>");
            sb.AppendLine("    <h3>Trạng thái Thiết bị</h3>");
            sb.AppendLine("    <p>Chưa có thiết bị nào được kết nối.</p>");
            sb.AppendLine("</div>");
            return sb.ToString();
        }

        sb.AppendLine("<div class='section'>");
        sb.AppendLine("    <h3>Trạng thái Thiết bị</h3>");
        sb.AppendLine("    <div class='info-grid'>");
        sb.AppendLine("        <div class='info-item'>");
        sb.AppendLine("            <span class='info-label'>Tổng số thiết bị:</span>");
        sb.AppendLine($"            <span class='info-value'>{deviceStatus.TotalDevices}</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class='info-item'>");
        sb.AppendLine("            <span class='info-label'>Thiết bị online:</span>");
        sb.AppendLine($"            <span class='info-value'>{deviceStatus.OnlineDevices}</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("        <div class='info-item'>");
        sb.AppendLine("            <span class='info-label'>Thiết bị offline:</span>");
        sb.AppendLine($"            <span class='info-value'>{deviceStatus.OfflineDevices}</span>");
        sb.AppendLine("        </div>");
        sb.AppendLine("    </div>");
        
        if (deviceStatus.Devices?.Any() == true)
        {
            sb.AppendLine("    <h4>Chi tiết thiết bị:</h4>");
            foreach (var device in deviceStatus.Devices)
            {
                var displayName = GetDeviceDisplayName(device.Model);
                var lastSync = "Chưa đồng bộ";
                if (!string.IsNullOrEmpty(device.LastSyncAt) && DateTime.TryParse(device.LastSyncAt, out DateTime lastSyncDate))
                {
                    lastSync = lastSyncDate.ToString("dd/MM/yyyy HH:mm");
                }
                
                sb.AppendLine("    <div class='info-item'>");
                sb.AppendLine($"        <span class='info-label'>{displayName}:</span>");
                sb.AppendLine($"        <span class='info-value'>{device.Status} - Đồng bộ cuối: {lastSync}</span>");
                sb.AppendLine("    </div>");
            }
        }
        
        sb.AppendLine("</div>");
        return sb.ToString();
    }

    private async Task DownloadHtmlReport(string htmlContent, string fileName)
    {
        try
        {
            var escapedHtml = htmlContent.Replace("'", "\\'").Replace("`", "\\`").Replace("\n", "\\n").Replace("\r", "");
            
            var jsCode = $@"
                const blob = new Blob([`{escapedHtml}`], {{ type: 'text/html' }});
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '{fileName}';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            ";
            
            await JSRuntime.InvokeVoidAsync("eval", jsCode);
        }
        catch (Exception)
        {
            // Fallback: Open in new window
            var bytes = System.Text.Encoding.UTF8.GetBytes(htmlContent);
            var base64 = Convert.ToBase64String(bytes);
            
            await JSRuntime.InvokeVoidAsync("eval", $@"
                const newWindow = window.open();
                newWindow.document.write(atob('{base64}'));
                newWindow.document.close();
            ");
        }
    }

    private class HealthReportData
    {
        public User Student { get; set; } = null!;
        public DateTime GeneratedDate { get; set; }
        public string ReportPeriod { get; set; } = string.Empty;
        public HealthMetrics CurrentMetrics { get; set; } = new();
        public WeeklyStatistics WeeklyStats { get; set; } = new();
        public HealthStatistics MonthlyStats { get; set; } = new();
        public List<HealthInsight> Insights { get; set; } = new();
        public HealthGoals Goals { get; set; } = new();
        public List<DailyStat> DailyBreakdown { get; set; } = new();
        public DeviceStatusSummary? DeviceStatus { get; set; }
    }
    #endregion
}