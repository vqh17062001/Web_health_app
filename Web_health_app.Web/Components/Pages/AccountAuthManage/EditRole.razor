@page "/accountAuthManage/editrole/{RoleId}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using Web_health_app.Web.Components.Layout
@using Web_health_app.Web.ApiClients
@using Models.Models
@inject RoleApiClient RoleApiClient
@inject PermissionApiClient PermissionApiClient
@inject ActionEntityApiClient ActionEntityApiClient
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

@layout EmptyLayout
@attribute [Authorize(Roles = "ACCESS.EditRole")]

<link href="/css/AccountAuthManage/add-role.css" rel="stylesheet" />

<div class="add-role-container">
    <div class="add-role-card">
        <!-- Header -->
        <div class="card-header">
            <div class="header-content">
                <div class="header-icon">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="header-text">
                    <h2>Chỉnh Sửa Vai Trò</h2>
                    <p>Cập nhật thông tin vai trò và phân quyền</p>
                </div>
            </div>
            <button type="button" class="btn-close" aria-label="Đóng"
                @onclick="@(() => Navigation.NavigateTo("/accountAuthManage"))">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Form Content -->
        <div class="card-body">
            @if (isLoading)
            {
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-2">Đang tải thông tin vai trò...</p>
                </div>
            }
            else if (currentRole == null)
            {
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Không tìm thấy vai trò cần chỉnh sửa.
                </div>
            }
            else
            {
                <EditForm Model="@updateRoleDto" OnValidSubmit="HandleSubmit" class="add-role-form">
                    <DataAnnotationsValidator />

                    <!-- Current Role Info Display -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Thông tin hiện tại
                        </h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-tag"></i>
                                    Mã vai trò
                                </label>
                                <div class="info-display">
                                    <i class="fas fa-fingerprint"></i>
                                    @currentRole.RoleId
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-users"></i>
                                    Số người dùng
                                </label>
                                <div class="info-display">
                                    <i class="fas fa-user-friends"></i>
                                    @currentRole.UserCount người dùng
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-toggle-on"></i>
                                    Trạng thái hiện tại
                                </label>
                                <div class="status-badge @(currentRole.IsActive ? "active" : "inactive")">
                                    <i class="fas @(currentRole.IsActive ? "fa-check-circle" : "fa-times-circle")"></i>
                                    @(currentRole.IsActive ? "Đang hoạt động" : "Tạm khóa")
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-shield-alt"></i>
                                    Số quyền hiện tại
                                </label>
                                <div class="info-display">
                                    <i class="fas fa-key"></i>
                                    @currentRole.PermissionCount quyền
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Basic Role Information -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-edit"></i>
                            Chỉnh sửa thông tin
                        </h3>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-signature"></i>
                                    Tên vai trò <span class="required">*</span>
                                </label>
                                <InputText @bind-Value="updateRoleDto.RoleName" class="form-control"
                                    placeholder="Nhập tên vai trò" maxlength="100" />
                                <ValidationMessage For="@(() => updateRoleDto.RoleName)" class="text-danger" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <i class="fas fa-toggle-on"></i>
                                    Trạng thái
                                </label>
                                <InputSelect @bind-Value="updateRoleDto.IsActive" class="form-select">
                                    <option value="true">Hoạt động</option>
                                    <option value="false">Tạm khóa</option>
                                </InputSelect>
                            </div>
                        </div>
                    </div>

                    <!-- Permissions Section -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-key"></i>
                            Phân quyền truy cập
                        </h3>

                        @if (actions != null && actions.Any() && entities != null && entities.Any())
                        {
                            <div class="permissions-container">
                                <!-- Matrix 1: Access to Pages -->
                                <div class="permission-matrix-section">
                                    <h4 class="matrix-title">
                                        <i class="fas fa-desktop"></i>
                                        Quyền truy cập trang (ACCESS - PAGE)
                                    </h4>

                                    @if (accessActions.Any() && pageEntities.Any())
                                    {
                                        <div class="permission-table">
                                            <div class="table-header">
                                                <div class="module-col">Trang / Quyền truy cập</div>
                                                @foreach (var action in accessActions)
                                                {
                                                    <div class="action-col">@action.ActionName</div>
                                                }
                                            </div>

                                            @foreach (var entity in pageEntities)
                                            {
                                                <div class="table-row">
                                                    <div class="module-name">
                                                        <i class="fas fa-file-alt"></i>
                                                        @entity.NameEntity
                                                    </div>
                                                    @foreach (var action in accessActions)
                                                    {
                                                        <div class="action-checkbox">
                                                            <input type="checkbox" id="@($"access_{action.ActionId}_{entity.EntityId}")"
                                                                class="permission-checkbox"
                                                                checked="@IsPermissionSelected(action.ActionId, entity.EntityId)"
                                                                @onchange="@((e) => TogglePermission(action.ActionId, entity.EntityId, (bool)(e.Value ?? false)))" />
                                                            <label for="@($"access_{action.ActionId}_{entity.EntityId}")"
                                                                class="checkbox-label"></label>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>

                                        <div class="permission-actions">
                                            <button type="button" class="btn-action btn-select-all"
                                                @onclick="SelectAllAccessPermissions">
                                                <i class="fas fa-check-square"></i>
                                                Chọn tất cả trang
                                            </button>
                                            <button type="button" class="btn-action btn-deselect-all"
                                                @onclick="DeselectAllAccessPermissions">
                                                <i class="fas fa-square"></i>
                                                Bỏ chọn tất cả trang
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Không tìm thấy dữ liệu ACCESS action hoặc page entities
                                        </div>
                                    }
                                </div>

                                <!-- Matrix 2: Actions on Tables -->
                                <div class="permission-matrix-section mt-4">
                                    <h4 class="matrix-title">
                                        <i class="fas fa-table"></i>
                                        Quyền thao tác dữ liệu (ACTIONS - TABLE)
                                    </h4>
                                    
                                    @if (dataActions.Any() && tableEntities.Any())
                                    {
                                        <div class="data-permission-container">
                                            @foreach (var entity in tableEntities)
                                            {
                                                <div class="entity-permission-group">
                                                    <div class="entity-header">
                                                        <i class="fas fa-database"></i>
                                                        <strong>@entity.NameEntity</strong>
                                                    </div>
                                                    
                                                    <div class="action-grid">
                                                        @foreach (var action in dataActions)
                                                        {
                                                            <div class="action-item">
                                                                <label class="action-label">@action.ActionName</label>
                                                                <div class="action-checkbox">
                                                                    <input type="checkbox" 
                                                                           id="@($"data_{action.ActionId}_{entity.EntityId}")"
                                                                           class="permission-checkbox"
                                                                           checked="@IsPermissionSelected(action.ActionId, entity.EntityId)"
                                                                           @onchange="@((e) => TogglePermission(action.ActionId, entity.EntityId, (bool)(e.Value ?? false)))" />
                                                                    <label for="@($"data_{action.ActionId}_{entity.EntityId}")" class="checkbox-label"></label>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                </div>
                                            }
                                        </div>

                                        <div class="permission-actions">
                                            <button type="button" class="btn-action btn-select-all"
                                                @onclick="SelectAllDataPermissions">
                                                <i class="fas fa-check-square"></i>
                                                Chọn tất cả dữ liệu
                                            </button>
                                            <button type="button" class="btn-action btn-deselect-all"
                                                @onclick="DeselectAllDataPermissions">
                                                <i class="fas fa-square"></i>
                                                Bỏ chọn tất cả dữ liệu
                                            </button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-warning">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            Không tìm thấy dữ liệu thao tác hoặc table entities
                                        </div>
                                    }
                                </div>

                                <!-- Global Quick Actions -->
                                <div class="permission-actions mt-3">
                                    <button type="button" class="btn-action btn-select-all" @onclick="SelectAllPermissions">
                                        <i class="fas fa-check-double"></i>
                                        Chọn tất cả quyền
                                    </button>
                                    <button type="button" class="btn-action btn-deselect-all" @onclick="DeselectAllPermissions">
                                        <i class="fas fa-times-circle"></i>
                                        Bỏ chọn tất cả quyền
                                    </button>
                                </div>

                                <!-- Selected Permissions Summary -->
                                @if (selectedPermissions.Any())
                                {
                                    <div class="selected-permissions-summary">
                                        <h6>Quyền đã chọn (@selectedPermissions.Count)</h6>
                                        <div class="permissions-badges">
                                            @foreach (var permission in selectedPermissions)
                                            {
                                                var action = actions?.FirstOrDefault(a => a.ActionId == permission.ActionId);
                                                var entity = entities?.FirstOrDefault(e => e.EntityId == permission.EntityId);
                                                <span class="badge bg-secondary me-1 mb-1">
                                                    @action?.ActionName - @entity?.NameEntity
                                                    <button type="button" class="btn-close btn-close-white ms-1" aria-label="Remove"
                                                            @onclick="@(() => TogglePermission(permission.ActionId, permission.EntityId, false))"></button>
                                                </span>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> Đang tải dữ liệu phân quyền...
                            </div>
                        }
                    </div>
                </EditForm>
            }
        </div>

        <!-- Footer Actions -->
        <div class="card-footer">
            <div class="action-buttons">
                <button type="button" class="btn btn-cancel"
                    @onclick="@(() => Navigation.NavigateTo("/accountAuthManage"))">
                    <i class="fas fa-times"></i>
                    Hủy
                </button>
                @* @if (currentRole != null)
                {
                    <button type="button" class="btn btn-danger" @onclick="DeleteRole" disabled="@isDeleting">
                        @if (isDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        }
                        <i class="fas fa-trash"></i>
                        @(isDeleting ? "Đang xóa..." : "Xóa vai trò")
                    </button>
                } *@
                <button type="button" class="btn btn-reset" @onclick="ResetForm">
                    <i class="fas fa-undo"></i>
                    Khôi phục
                </button>
                <button type="button" class="btn btn-primary" @onclick="HandleSubmit" disabled="@isSubmitting">
                    @if (isSubmitting)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                    }
                    <i class="fas fa-save"></i>
                    @(isSubmitting ? "Đang cập nhật..." : "Cập nhật vai trò")
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Messages -->
@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger position-fixed top-0 end-0 m-3" style="z-index: 1050;">
        <i class="fas fa-exclamation-triangle"></i> @errorMessage
        <button type="button" class="btn-close" @onclick="@(() => errorMessage = string.Empty)"></button>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success position-fixed top-0 end-0 m-3" style="z-index: 1050;">
        <i class="fas fa-check-circle"></i> @successMessage
        <button type="button" class="btn-close" @onclick="@(() => successMessage = string.Empty)"></button>
    </div>
}

@code {
    [Parameter] public string? RoleId { get; set; }

    private RoleInfoDto? currentRole;
    private UpdateRoleDto updateRoleDto = new();
    private List<ActionInfoDto> actions = new();
    private List<EntityInfoDto> entities = new();
    private List<PermissionSelection> selectedPermissions = new();
    private List<PermissionInfoDto> currentPermissions = new();

    private bool isLoading = true;
    private bool isSubmitting = false;
    private bool isDeleting = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    // Filtered data for the two matrices
    private List<ActionInfoDto> accessActions => actions.Where(a => a.ActionId == "ACCESS").ToList();
    private List<ActionInfoDto> dataActions => actions.Where(a => a.ActionId != "ACCESS").OrderBy(a =>
    a.ActionId.Length).ToList();
    private List<EntityInfoDto> pageEntities => entities.Where(e => e.Type == "page").ToList();
    private List<EntityInfoDto> tableEntities => entities.Where(e => e.Type == "table").ToList();

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(RoleId))
        {
            errorMessage = "Thiếu mã vai trò cần chỉnh sửa";
            isLoading = false;
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            isLoading = true;

            // Load role info, actions, entities, and current permissions in parallel
            var roleTask = RoleApiClient.GetRoleByIdAsync(RoleId!);
            var actionsTask = ActionEntityApiClient.GetActiveActionsAsync();
            var entitiesTask = ActionEntityApiClient.GetEntitiesBySecurityLevelAsync(5);
            var permissionsTask = PermissionApiClient.GetPermissionsByRoleIdAsync(RoleId!);

            await Task.WhenAll(roleTask, actionsTask, entitiesTask, permissionsTask);

            var roleResponse = await roleTask;
            var actionsResponse = await actionsTask;
            var entitiesResponse = await entitiesTask;
            var permissionsResponse = await permissionsTask;

            currentRole = roleResponse?.Data;
            actions = actionsResponse?.Data ?? new List<ActionInfoDto>();
            entities = entitiesResponse?.Data ?? new List<EntityInfoDto>();
            currentPermissions = permissionsResponse?.Data ?? new List<PermissionInfoDto>();

            if (currentRole == null)
            {
                errorMessage = "Không tìm thấy vai trò cần chỉnh sửa";
                return;
            }

            // Initialize update DTO with current values
            updateRoleDto.RoleName = currentRole.RoleName;
            updateRoleDto.IsActive = currentRole.IsActive;

            // Load current permissions into selectedPermissions
            selectedPermissions = currentPermissions.Select(p => new PermissionSelection
            {
                ActionId = p.ActionId,
                EntityId = p.EntityId
            }).ToList();
            
            // Force UI update to reflect loaded permissions
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi tải dữ liệu: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private bool IsPermissionSelected(string actionId, string entityId)
    {
        return selectedPermissions.Any(p => p.ActionId == actionId && p.EntityId == entityId);
    }

    private void TogglePermission(string actionId, string entityId, bool isSelected)
    {
        var existing = selectedPermissions.FirstOrDefault(p => p.ActionId == actionId && p.EntityId == entityId);

        if (isSelected && existing == null)
        {
            selectedPermissions.Add(new PermissionSelection { ActionId = actionId, EntityId = entityId });
        }
        else if (!isSelected && existing != null)
        {
            selectedPermissions.Remove(existing);
        }
        
        // Force UI update
        StateHasChanged();
    }

    // Global permission methods
    private void SelectAllPermissions()
    {
        selectedPermissions.Clear();
        foreach (var action in actions)
        {
            foreach (var entity in entities)
            {
                selectedPermissions.Add(new PermissionSelection { ActionId = action.ActionId, EntityId = entity.EntityId });
            }
        }
        StateHasChanged();
    }

    private void DeselectAllPermissions()
    {
        selectedPermissions.Clear();
        StateHasChanged();
    }

    // Access permissions methods
    private void SelectAllAccessPermissions()
    {
        // Remove existing access permissions first
        selectedPermissions.RemoveAll(p => accessActions.Any(a => a.ActionId == p.ActionId) &&
        pageEntities.Any(e => e.EntityId == p.EntityId));

        // Add all access permissions
        foreach (var action in accessActions)
        {
            foreach (var entity in pageEntities)
            {
                selectedPermissions.Add(new PermissionSelection { ActionId = action.ActionId, EntityId = entity.EntityId });
            }
        }
        StateHasChanged();
    }

    private void DeselectAllAccessPermissions()
    {
        selectedPermissions.RemoveAll(p => accessActions.Any(a => a.ActionId == p.ActionId) &&
        pageEntities.Any(e => e.EntityId == p.EntityId));
        StateHasChanged();
    }

    // Data permissions methods
    private void SelectAllDataPermissions()
    {
        // Remove existing data permissions first
        selectedPermissions.RemoveAll(p => dataActions.Any(a => a.ActionId == p.ActionId) &&
        tableEntities.Any(e => e.EntityId == p.EntityId));

        // Add all data permissions
        foreach (var action in dataActions)
        {
            foreach (var entity in tableEntities)
            {
                selectedPermissions.Add(new PermissionSelection { ActionId = action.ActionId, EntityId = entity.EntityId });
            }
        }
        StateHasChanged();
    }

    private void DeselectAllDataPermissions()
    {
        selectedPermissions.RemoveAll(p => dataActions.Any(a => a.ActionId == p.ActionId) &&
        tableEntities.Any(e => e.EntityId == p.EntityId));
        StateHasChanged();
    }

    private void ResetForm()
    {
        if (currentRole != null)
        {
            updateRoleDto.RoleName = currentRole.RoleName;
            updateRoleDto.IsActive = currentRole.IsActive;

            // Reset permissions to original state
            selectedPermissions = currentPermissions.Select(p => new PermissionSelection
            {
                ActionId = p.ActionId,
                EntityId = p.EntityId
            }).ToList();
        }

        errorMessage = string.Empty;
        successMessage = string.Empty;
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        if (isSubmitting || currentRole == null) return;

        try
        {
            isSubmitting = true;
            errorMessage = string.Empty;

            // Validate form
            if (string.IsNullOrWhiteSpace(updateRoleDto.RoleName))
            {
                errorMessage = "Vui lòng nhập tên vai trò";
                return;
            }

            // Update role information
            var roleResponse = await RoleApiClient.UpdateRoleAsync(currentRole.RoleId, updateRoleDto);
            if (roleResponse?.Data == null)
            {
                errorMessage = "Không thể cập nhật thông tin vai trò";
                return;
            }

            // Update permissions
            await UpdateRolePermissions();

            successMessage = "Cập nhật vai trò thành công!";

            // Reload data to reflect changes
            await LoadData();
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi cập nhật vai trò: {ex.Message}";
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task UpdateRolePermissions()
    {
        if (currentRole == null) return;

        try
        {
            // Compare current permissions with selected permissions
            var currentPermissionKeys = currentPermissions.Select(p => $"{p.ActionId}_{p.EntityId}").ToHashSet();
            var selectedPermissionKeys = selectedPermissions.Select(p => $"{p.ActionId}_{p.EntityId}").ToHashSet();

            // Find permissions to add
            var permissionsToAdd = selectedPermissions
            .Where(p => !currentPermissionKeys.Contains($"{p.ActionId}_{p.EntityId}"))
            .ToList();

            // Find permissions to remove
            var permissionsToRemove = currentPermissions
            .Where(p => !selectedPermissionKeys.Contains($"{p.ActionId}_{p.EntityId}"))
            .ToList();

            // Add new permissions
            foreach (var permission in permissionsToAdd)
            {
                var createPermissionDto = new CreatePermissionDto
                {
                    RoleId = currentRole.RoleId,
                    ActionId = permission.ActionId,
                    EntityId = permission.EntityId,
                    IsActive = true
                };

                await PermissionApiClient.CreatePermissionAsync(createPermissionDto);
            }

            // Remove deleted permissions
            foreach (var permission in permissionsToRemove)
            {
                if (!string.IsNullOrEmpty(permission.PermissionId))
                {
                    await PermissionApiClient.DeletePermissionAsync(permission.PermissionId);
                }
            }
        }
        catch (Exception ex)
        {
            throw new Exception($"Lỗi cập nhật quyền: {ex.Message}");
        }
    }

    private async Task DeleteRole()
    {
        if (isDeleting || currentRole == null) return;

        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
        $"Bạn có chắc chắn muốn xóa vai trò '{currentRole.RoleName}'? Hành động này không thể hoàn tác.");

        if (!confirmed) return;

        try
        {
            isDeleting = true;
            errorMessage = string.Empty;

            var response = await RoleApiClient.DeleteRoleAsync(currentRole.RoleId);
            if (response?.IsSuccess == true)
            {
                successMessage = "Xóa vai trò thành công!";
                await Task.Delay(1500);
                Navigation.NavigateTo("/accountAuthManage");
            }
            else
            {
                errorMessage = "Không thể xóa vai trò. Vui lòng kiểm tra xem vai trò có đang được sử dụng hay không.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Lỗi xóa vai trò: {ex.Message}";
        }
        finally
        {
            isDeleting = false;
        }
    }

    public class PermissionSelection
    {
        public string ActionId { get; set; } = string.Empty;
        public string EntityId { get; set; } = string.Empty;
    }
}
}